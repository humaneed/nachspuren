<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Tafel-ABC Nachspuren ¬∑ Druckschrift</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #265847 0, #123024 40%, #071810 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0f172a;
    }
    .shell {
      width: 100%;
      max-width: 520px;
      max-height: 100vh;
      aspect-ratio: 9 / 16; /* fester 9:16 Frame */
      padding: 12px;
      display: flex;
      align-items: stretch;
    }

    /* √Ñu√üerer Icon-Rahmen in dunklem Gr√ºn */
    .board {
      background: radial-gradient(circle at 20% 0%, #1b4a37 0, #0f3626 45%, #0b2419 100%);
      border-radius: 28px;
      box-shadow:
        0 18px 45px rgba(0,0,0,0.5),
        inset 0 0 0 1px rgba(15,23,42,0.2);
      color: inherit;
      padding: 10px;
      width: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    .board::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at top left, rgba(255,255,255,0.06), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
    }

    /* Helle ‚ÄûKarte‚Äú im Icon-Stil */
    .board-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px 12px 12px;
      border-radius: 22px;
      background: linear-gradient(145deg, #f7f1e3 0%, #eee1cd 40%, #e8dac3 100%);
      box-shadow:
        0 10px 22px rgba(0,0,0,0.35),
        0 0 0 1px rgba(148,163,184,0.18);
      height: 100%; /* nutzt gesamte 9:16-H√∂he */
    }

    .board-header {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 2px 2px 4px;
    }
    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    .board-title {
      font-size: 1.2rem;
      font-weight: 800;
      letter-spacing: 0.03em;
      color: #14532d;
    }
    .board-subtitle {
      font-size: 0.7rem;
      color: #6b7280;
      text-align: right;
    }

    .abc-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-top: 2px;
    }
    .current-letter-label {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      white-space: nowrap;
      color: #0f172a;
    }

    /* Toggle wie kleine Chips auf der Karte */
    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.75);
      overflow: hidden;
      font-size: 0.7rem;
      background: rgba(15,23,42,0.02);
      box-shadow: 0 2px 4px rgba(15,23,42,0.18);
    }
    .mode-btn {
      border: none;
      padding: 4px 10px;
      background: transparent;
      color: #475569;
      cursor: pointer;
      font-weight: 600;
      opacity: 0.8;
    }
    .mode-btn.active {
      background: #14532d;
      color: #fefce8;
      opacity: 1;
    }

    .controls-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .pill-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }
    .select {
      padding: 4px 8px;
      font-size: 0.78rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: #fdf7ea;
      color: #0f172a;
      box-shadow: 0 2px 4px rgba(148,163,184,0.45);
    }

    .color-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .color-dot {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid transparent;
      cursor: pointer;
      box-shadow:
        0 0 0 1px rgba(148,163,184,0.7),
        0 2px 4px rgba(15,23,42,0.25);
    }
    .color-dot.active {
      border-color: #fefce8;
      box-shadow:
        0 0 0 2px rgba(250,250,249,0.9),
        0 3px 7px rgba(15,23,42,0.35);
    }

    /* Tafelbereich: f√ºllt den restlichen Platz */
    .canvas-wrap {
      position: relative;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.9);
      background: radial-gradient(circle at top, #14532d 0, #0b281b 55%, #081710 100%);
      overflow: hidden;
      margin-top: 6px;
      box-shadow:
        inset 0 0 0 1px rgba(15,23,42,0.35),
        0 6px 14px rgba(15,23,42,0.45);
      flex: 1 1 auto;   /* nimmt das, was √ºbrig bleibt */
      min-height: 0;
    }
    #traceCanvas {
      display: block;
      width: 100%;
      height: 100%;     /* Canvas f√ºllt die Tafel */
      touch-action: none;
      background: transparent;
    }

    .buttons-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    /* Buttons wie kleine Karten/Chips */
    .btn {
      flex: 1 1 0;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      padding: 7px 10px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: #f7f1e3;
      color: #14532d;
      box-shadow:
        0 2px 4px rgba(15,23,42,0.25),
        0 0 0 1px rgba(255,255,255,0.75);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 2px rgba(15,23,42,0.4),
        0 0 0 1px rgba(255,255,255,0.6);
    }
    .btn-accent {
      background: #facc15;
      color: #1f2933;
      border-color: rgba(202,138,4,0.9);
    }
    .btn-check {
      background: #22c55e;
      color: #052e16;
      border-color: rgba(22,163,74,0.95);
    }

    .hint-row {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #4b5563;
    }
    .hint-strong {
      font-weight: 600;
      color: #111827;
    }

    /* Feedback-Kasten wie kleine eingef√§rbte Karte */
    .feedback-box {
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #fdf7ea;
      border: 1px solid rgba(148,163,184,0.7);
      min-height: 48px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(15,23,42,0.25);
    }
    .feedback-box.hidden {
      display: none;
    }
    .feedback-box.success {
      background: #e4fbe9;
      border-color: rgba(34,197,94,0.8);
    }
    .feedback-box.partial {
      background: #fff4e6;
      border-color: rgba(251,146,60,0.9);
    }
    .feedback-box.try-again {
      background: #fee2e2;
      border-color: rgba(239,68,68,0.9);
    }
    .feedback-title {
      font-size: 0.9rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #111827;
    }
    .feedback-text {
      font-size: 0.8rem;
      line-height: 1.4;
      color: #374151;
    }
    .score-bar {
      margin-top: 2px;
      height: 6px;
      background: rgba(148,163,184,0.4);
      border-radius: 999px;
      overflow: hidden;
    }
    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    @media (min-width: 540px) {
      .board-title { font-size: 1.3rem; }
    }

    @media (max-width: 420px) {
      .shell { padding: 8px; }
      .board { border-radius: 22px; padding: 8px; }
      .board-inner { border-radius: 20px; padding: 9px 10px 11px; }
      .board-title { font-size: 1.15rem; }
      .current-letter-label { font-size: 1.4rem; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="board">
      <div class="board-inner">
        <header class="board-header">
          <div class="title-row">
            <div class="board-title">Mein Tafel ABC</div>
            <div class="board-subtitle">Druckschrift ¬∑ Nachspuren</div>
          </div>
          <div class="abc-row">
            <div id="currentPair" class="current-letter-label">A a</div>
            <div class="mode-toggle">
              <button class="mode-btn active" data-mode="upper">ABC</button>
              <button class="mode-btn" data-mode="lower">abc</button>
              <button class="mode-btn" data-mode="digits">123</button>
            </div>
          </div>
        </header>

        <div class="controls-row">
          <span class="pill-label">Zeichen</span>
          <select id="charSelect" class="select"></select>
        </div>

        <div class="color-row">
          <span class="pill-label">Kreide</span>
          <button class="color-dot" data-color="#facc15" style="background:#facc15;"></button>
          <button class="color-dot active" data-color="#e5e7eb" style="background:#e5e7eb;"></button>
          <button class="color-dot" data-color="#38bdf8" style="background:#38bdf8;"></button>
          <button class="color-dot" data-color="#f97316" style="background:#f97316;"></button>
          <button class="color-dot" data-color="#22c55e" style="background:#22c55e;"></button>
          <button class="color-dot" data-color="#fb7185" style="background:#fb7185;"></button>
        </div>

        <div class="canvas-wrap">
          <canvas id="traceCanvas" width="600" height="320"></canvas>
        </div>

        <div class="buttons-row">
          <button id="btnPrev" class="btn">‚¨ÖÔ∏è Zur√ºck</button>
          <button id="btnRandom" class="btn btn-accent">üé≤ Zufall</button>
          <button id="btnNext" class="btn">Weiter ‚û°Ô∏è</button>
        </div>
        <div class="buttons-row">
          <button id="btnClear" class="btn">üßΩ Tafel wischen</button>
          <button id="btnCheck" class="btn btn-check">‚úì Pr√ºfen</button>
          <button id="btnToggleGuide" class="btn">üëÅ Vorlage aus</button>
        </div>

        <div id="feedbackBox" class="feedback-box hidden">
          <div class="feedback-title" id="feedbackTitle"></div>
          <div class="feedback-text" id="feedbackText"></div>
          <div class="score-bar">
            <div class="score-fill" id="scoreFill" style="width: 0%"></div>
          </div>
        </div>

        <div class="hint-row">
          <div id="exampleHint" class="hint-strong"></div>
          <div id="tipHint"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- JS (nur resizeCanvas angepasst auf flex-H√∂he) -->
  <script>
    const UPPER = "A√ÑBCDEFGHIJKLMNO√ñPQRSTUVW√úXYZ".split("");
    const LOWER = "a√§bcdefghijklmno√∂pqrstuvw√ºxyz√ü".split("");
    const DIGITS = "0123456789".split("");

    const ASCENDERS = new Set(['b', 'd', 'f', 'h', 'k', 'l', 't', '√ü']);
    const DESCENDERS = new Set(['g', 'j', 'p', 'q', 'y']);
    const DOTS_ABOVE = new Set(['√Ñ', '√ñ', '√ú', '√§', '√∂', '√º', 'i', 'j']);

    const LETTER_EXAMPLES = {
      A: "A wie Apfel", √Ñ: "√Ñ wie √Ñpfel",
      B: "B wie Ball",
      C: "C wie Computer",
      D: "D wie Dinosaurier",
      E: "E wie Esel",
      F: "F wie Fisch",
      G: "G wie Gitarre",
      H: "H wie Herz",
      I: "I wie Igel",
      J: "J wie Jacke",
      K: "K wie Kerze",
      L: "L wie Leiter",
      M: "M wie Haus",
      N: "N wie Nagel",
      O: "O wie Ofen", √ñ: "√ñ wie √ñfen",
      P: "P wie Palme",
      Q: "Q wie Qualle",
      R: "R wie Rakete",
      S: "S wie Sonne",
      T: "T wie Tiger",
      U: "U wie Uhr", √ú: "√ú wie √úbung",
      V: "V wie Vogel",
      W: "W wie Wolke",
      X: "X wie Xylophon",
      Y: "Y wie Yacht",
      Z: "Z wie Zeit"
    };

    const DIGIT_EXAMPLES = {
      0: "0 ‚Äì Ein runder Kreis.",
      1: "1 ‚Äì Ein Strich, ein Finger.",
      2: "2 ‚Äì Zwei Augen, zwei Schuhe.",
      3: "3 ‚Äì Drei Schritte.",
      4: "4 ‚Äì Vier R√§der am Auto.",
      5: "5 ‚Äì F√ºnf Finger an der Hand.",
      6: "6 ‚Äì Sechs Bausteine.",
      7: "7 ‚Äì Sieben Wochentage.",
      8: "8 ‚Äì Wie ein Schneemann.",
      9: "9 ‚Äì Neun Punkte."
    };

    const modeButtons = Array.from(document.querySelectorAll(".mode-btn"));
    const charSelect = document.getElementById("charSelect");
    const currentPair = document.getElementById("currentPair");
    const canvas = document.getElementById("traceCanvas");
    const ctx = canvas.getContext("2d");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnRandom = document.getElementById("btnRandom");
    const btnClear = document.getElementById("btnClear");
    const btnCheck = document.getElementById("btnCheck");
    const btnToggleGuide = document.getElementById("btnToggleGuide");
    const colorDots = Array.from(document.querySelectorAll(".color-dot"));
    const exampleHint = document.getElementById("exampleHint");
    const tipHint = document.getElementById("tipHint");
    const feedbackBox = document.getElementById("feedbackBox");
    const feedbackTitle = document.getElementById("feedbackTitle");
    const feedbackText = document.getElementById("feedbackText");
    const scoreFill = document.getElementById("scoreFill");

    let mode = "upper";
    let list = UPPER;
    let index = 0;
    let currentChar = "A";
    let penColor = "#e5e7eb";
    let drawing = false;
    let lastX = 0;
    let lastY = 0;
    let showGuide = true;

    function setMode(newMode) {
      mode = newMode;
      if (mode === "upper") list = UPPER;
      else if (mode === "lower") list = LOWER;
      else list = DIGITS;

      modeButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });

      fillCharSelect();
      setCharByIndex(0);
    }

    function fillCharSelect() {
      charSelect.innerHTML = "";
      list.forEach((ch, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = ch;
        charSelect.appendChild(opt);
      });
    }

    function setCharByIndex(i) {
      if (!list.length) return;
      if (i < 0) i = list.length - 1;
      if (i >= list.length) i = 0;
      index = i;
      currentChar = list[index];
      charSelect.value = String(index);

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();

      if (mode === "upper") {
        currentPair.textContent = up + " " + low;
      } else if (mode === "lower") {
        currentPair.textContent = up + " " + low;
      } else {
        currentPair.textContent = currentChar;
      }

      updateHints();
      hideFeedback();
      clearCanvas();
    }

    function updateHints() {
      if (mode === "digits") {
        exampleHint.textContent = DIGIT_EXAMPLES[currentChar] || ("Zahl " + currentChar + " schreiben √ºben.");
        tipHint.textContent = "Sprich die Zahl laut aus und betrachte ihre Form genau. Fahre sie dann langsam mit dem Finger in der Luft nach, bevor du auf der Tafel schreibst.";
      } else {
        const upper = currentChar.toUpperCase();
        const base = LETTER_EXAMPLES[upper] || (upper + " schreiben √ºben.");
        exampleHint.textContent = base;
        tipHint.textContent = "Schau dir beide Buchstaben an: Wo beginnen sie? Welche Richtung nehmen sie? Spure dann langsam nach ‚Äì erst den gro√üen, dann den kleinen Buchstaben.";
      }
    }

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;

      // Canvas an die tats√§chliche Gr√∂√üe der flex-Tafel anpassen
      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;

      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      clearCanvas();
    }

    function clearCanvas() {
      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      ctx.clearRect(0, 0, w, h);
      drawGuidelinesAndLetter();
      hideFeedback();
    }

    function drawGuidelinesAndLetter() {
      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      if (!w || !h) return;

      ctx.save();
      ctx.lineWidth = 1.5;
      ctx.strokeStyle = "rgba(226,232,240,0.75)";

      const lineSpacing = h * 0.09;
      const centerY = h * 0.5;
      const line1 = centerY - lineSpacing * 1.5;
      const line2 = centerY - lineSpacing * 0.5;
      const line3 = centerY + lineSpacing * 0.5;
      const line4 = centerY + lineSpacing * 1.5;

      const xLeft = w * 0.08;
      const xRight = w * 0.92;

      [line1, line2, line3, line4].forEach((y, i) => {
        ctx.beginPath();
        ctx.setLineDash(i === 0 || i === 3 ? [] : [6, 4]);
        ctx.moveTo(xLeft, y);
        ctx.lineTo(xRight, y);
        ctx.stroke();
      });

      ctx.setLineDash([3, 5]);
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(w * 0.12, line1 - lineSpacing * 0.3);
      ctx.lineTo(w * 0.12, line4 + lineSpacing * 0.3);
      ctx.stroke();
      ctx.restore();

      if (!showGuide || !currentChar) return;

      ctx.save();
      const isDigit = mode === "digits";

      if (isDigit) {
        const digitHeight = line3 - line1;
        const fontSize = digitHeight * 0.95;
        ctx.font = `700 ${fontSize}px Arial, "Helvetica Neue", sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillStyle = "rgba(248,250,252,0.98)";
        ctx.globalAlpha = 0.32;
        ctx.fillText(currentChar, w * 0.5, line3);
      } else {
        const up = currentChar.toUpperCase();
        const low = currentChar.toLowerCase();

        const upperHeight = line3 - line1;
        const upperFontSize = upperHeight * 0.95;

        ctx.font = `700 ${upperFontSize}px Arial, "Helvetica Neue", sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillStyle = "rgba(248,250,252,0.98)";
        ctx.globalAlpha = 0.32;

        const upperX = w * 0.35;
        ctx.fillText(up, upperX, line3);

        let lowerFontSize, lowerBaseline;

        if (ASCENDERS.has(low)) {
          lowerFontSize = upperFontSize;
          lowerBaseline = line3;
        } else if (DESCENDERS.has(low)) {
          const lowerHeight = line4 - line2;
          lowerFontSize = lowerHeight * 0.95;
          lowerBaseline = line4;
        } else {
          const xHeight = line3 - line2;
          lowerFontSize = xHeight * 0.95;
          lowerBaseline = line3;
        }

        ctx.font = `700 ${lowerFontSize}px Arial, "Helvetica Neue", sans-serif`;
        const lowerX = w * 0.65;
        ctx.fillText(low, lowerX, lowerBaseline);
      }

      ctx.restore();
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches[0]) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function startDraw(e) {
      e.preventDefault();
      const pos = getPos(e);
      drawing = true;
      lastX = pos.x;
      lastY = pos.y;
    }

    function moveDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      const width = canvas.clientWidth || 300;
      const base = 0.015;
      ctx.lineWidth = Math.max(width * base, 2);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = penColor;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x;
      lastY = pos.y;
    }

    function endDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", moveDraw, { passive: false });
    canvas.addEventListener("touchend", endDraw, { passive: false });
    canvas.addEventListener("touchcancel", endDraw, { passive: false });

    function checkDrawing() {
      const refCanvas = createReferenceCanvas();
      const userCanvas = canvas;
      const refData = analyzeCanvas(refCanvas);
      const userData = analyzeCanvas(userCanvas);
      const score = compareDrawings(refData, userData);
      showFeedback(score);
    }

    function createReferenceCanvas() {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      tempCanvas.width = w;
      tempCanvas.height = h;

      const lineSpacing = h * 0.09;
      const centerY = h * 0.5;
      const line1 = centerY - lineSpacing * 1.5;
      const line2 = centerY - lineSpacing * 0.5;
      const line3 = centerY + lineSpacing * 0.5;
      const line4 = centerY + lineSpacing * 1.5;

      const isDigit = mode === "digits";

      if (isDigit) {
        const digitHeight = line3 - line1;
        const fontSize = digitHeight * 0.95;
        tempCtx.font = `700 ${fontSize}px Arial, sans-serif`;
        tempCtx.textAlign = "center";
        tempCtx.textBaseline = "alphabetic";
        tempCtx.fillStyle = "#ffffff";
        tempCtx.fillText(currentChar, w * 0.5, line3);
      } else {
        const up = currentChar.toUpperCase();
        const low = currentChar.toLowerCase();
        const upperHeight = line3 - line1;
        const upperFontSize = upperHeight * 0.95;

        tempCtx.font = `700 ${upperFontSize}px Arial, sans-serif`;
        tempCtx.textAlign = "center";
        tempCtx.textBaseline = "alphabetic";
        tempCtx.fillStyle = "#ffffff";
        tempCtx.fillText(up, w * 0.35, line3);

        let lowerFontSize, lowerBaseline;
        if (ASCENDERS.has(low)) {
          lowerFontSize = upperFontSize;
          lowerBaseline = line3;
        } else if (DESCENDERS.has(low)) {
          const lowerHeight = line4 - line2;
          lowerFontSize = lowerHeight * 0.95;
          lowerBaseline = line4;
        } else {
          const xHeight = line3 - line2;
          lowerFontSize = xHeight * 0.95;
          lowerBaseline = line3;
        }

        tempCtx.font = `700 ${lowerFontSize}px Arial, sans-serif`;
        tempCtx.fillText(low, w * 0.65, lowerBaseline);
      }

      return tempCanvas;
    }

    function analyzeCanvas(cnv) {
      const ctx = cnv.getContext('2d');
      const w = cnv.width;
      const h = cnv.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      const pixels = imageData.data;

      let filledPixels = 0;
      let minX = w, maxX = 0, minY = h, maxY = 0;
      const regions = { top: 0, middle: 0, bottom: 0, left: 0, right: 0, center: 0 };
      let topQuarterPixels = 0;
      const topQuarterLimit = h * 0.25;

      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const idx = (y * w + x) * 4;
          const alpha = pixels[idx + 3];

          if (alpha > 50) {
            filledPixels++;

            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;

            if (y < topQuarterLimit) {
              topQuarterPixels++;
            }

            if (y < h * 0.33) regions.top++;
            else if (y > h * 0.66) regions.bottom++;
            else regions.middle++;

            if (x < w * 0.33) regions.left++;
            else if (x > w * 0.66) regions.right++;
            else regions.center++;
          }
        }
      }

      const boundingWidth = maxX - minX;
      const boundingHeight = maxY - minY;
      const coverage = filledPixels / (w * h);

      return {
        filledPixels,
        coverage,
        boundingWidth,
        boundingHeight,
        centerX: (minX + maxX) / 2,
        centerY: (minY + maxY) / 2,
        regions,
        width: w,
        height: h,
        topQuarterPixels,
        topQuarterRatio: filledPixels ? topQuarterPixels / filledPixels : 0
      };
    }

    function compareDrawings(refData, userData) {
      let score = 0;
      const maxScore = 100;

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();
      const hasDots = DOTS_ABOVE.has(up) || DOTS_ABOVE.has(low);

      if (userData.filledPixels < 100) return 0;
      const drawingAmount = Math.min(1, userData.filledPixels / 200);
      score += drawingAmount * 15;

      const coveragePoints = hasDots ? 20 : 25;
      const coverageRatio = userData.coverage / refData.coverage;
      if (coverageRatio >= 0.5 && coverageRatio <= 2.0) {
        const deviation = Math.abs(1 - coverageRatio);
        if (deviation < 0.3) {
          score += coveragePoints * (1 - deviation / 0.3);
        } else {
          score += coveragePoints * Math.max(0, (0.5 - deviation) / 0.2);
        }
      }

      if (hasDots) {
        const refTopRatio = refData.topQuarterRatio;
        const userTopRatio = userData.topQuarterRatio;
        const topDiff = Math.abs(refTopRatio - userTopRatio);

        if (topDiff < 0.05) {
          score += 10;
        } else if (topDiff < 0.1) {
          score += 7;
        } else if (topDiff < 0.15) {
          score += 4;
        }
      } else {
        score += 5;
      }

      const centerDiffX = Math.abs(userData.centerX - refData.centerX);
      const centerDiffY = Math.abs(userData.centerY - refData.centerY);
      const maxCenterDiff = Math.max(userData.width, userData.height) * 0.2;
      const totalCenterDiff = (centerDiffX + centerDiffY) / maxCenterDiff;

      if (totalCenterDiff < 0.5) {
        score += 30 * (1 - totalCenterDiff / 0.5);
      } else if (totalCenterDiff < 1.0) {
        score += 30 * Math.max(0, (1.0 - totalCenterDiff) / 0.5) * 0.3;
      }

      let regionScore = 0;
      const regionKeys = ['top', 'middle', 'bottom', 'left', 'right', 'center'];

      regionKeys.forEach(key => {
        const refRatio = refData.regions[key] / refData.filledPixels || 0;
        const userRatio = userData.regions[key] / userData.filledPixels || 0;
        const diff = Math.abs(refRatio - userRatio);

        if (diff < 0.1) {
          regionScore += 1 - (diff / 0.1);
        } else if (diff < 0.2) {
          regionScore += (0.2 - diff) / 0.1 * 0.2;
        }
      });

      score += (regionScore / regionKeys.length) * 20;

      return Math.min(maxScore, Math.max(0, score));
    }

    function showFeedback(score) {
      feedbackBox.classList.remove('hidden', 'success', 'partial', 'try-again');

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();
      const hasDots = DOTS_ABOVE.has(up) || DOTS_ABOVE.has(low);

      let emoji, title, text, cssClass;

      if (score >= 85) {
        emoji = "üåü";
        title = "Perfekt geschrieben!";
        text = hasDots
          ? "Wow! Du hast den Buchstaben wirklich sorgf√§ltig nachgespurt. Die Punkte oben hast du auch richtig gesetzt! Du hast genau auf die Linien geachtet und die Form sehr gut getroffen."
          : "Wow! Du hast den Buchstaben wirklich sorgf√§ltig nachgespurt. Du hast genau auf die Linien geachtet und die Form sehr gut getroffen. Das zeigt, dass du mit Konzentration und Ruhe arbeitest!";
        cssClass = "success";
      } else if (score >= 70) {
        emoji = "‚≠ê";
        title = "Sehr gut gemacht!";
        text = hasDots
          ? "Prima! Deine Schrift sieht schon richtig gut aus. Die Punkte sind da und die Form stimmt. Mit etwas mehr √úbung wird es noch besser!"
          : "Prima! Deine Schrift sieht schon richtig gut aus. Du hast die richtige Form und bleibst gut auf den Linien. Mit etwas mehr √úbung wird es noch besser!";
        cssClass = "success";
      } else if (score >= 50) {
        emoji = "‚úÖ";
        title = "Geschafft!";
        text = hasDots
          ? "Gut gemacht! Du hast die Aufgabe gemeistert. Deine Form ist erkennbar und die Punkte sind da. Wenn du magst, kannst du es nochmal probieren und noch genauer arbeiten."
          : "Gut gemacht! Du hast die Aufgabe gemeistert. Deine Form ist erkennbar und du bist den Linien gefolgt. Wenn du magst, kannst du es nochmal probieren und noch genauer arbeiten.";
        cssClass = "success";
      } else if (score >= 35) {
        emoji = "üí™";
        title = "Fast geschafft!";
        text = hasDots
          ? "Du bist schon sehr nah dran! Achte besonders auf die Punkte oben ‚Äì sie geh√∂ren zum Buchstaben dazu. Spure die Vorlage langsam nach, dann klappt es!"
          : "Du bist schon sehr nah dran! Versuch beim n√§chsten Mal, die Vorlage noch genauer nachzuspuren. Nimm dir Zeit und folge den Linien langsam St√ºck f√ºr St√ºck. Du kannst das!";
        cssClass = "partial";
      } else {
        emoji = "üéØ";
        title = "Versuch es nochmal!";
        text = hasDots
          ? "Lass uns gemeinsam √ºben! Schau dir die Vorlage genau an: Der Buchstabe hat Punkte oben ‚Äì die sind ganz wichtig! Spure erst den Buchstaben und dann die Punkte nach. Jeder Versuch macht dich besser!"
          : "Lass uns gemeinsam √ºben! Schau dir die Vorlage genau an: Wo beginnt der Buchstabe? Wo endet er? Spure dann langsam und vorsichtig nach. Jeder Versuch macht dich besser!";
        cssClass = "try-again";
      }

      feedbackBox.classList.add(cssClass);
      feedbackTitle.textContent = emoji + " " + title;
      feedbackText.textContent = text;
      scoreFill.style.width = score + "%";
    }

    function hideFeedback() {
      feedbackBox.classList.add('hidden');
      scoreFill.style.width = "0%";
    }

    colorDots.forEach(dot => {
      dot.addEventListener("click", () => {
        colorDots.forEach(d => d.classList.remove("active"));
        dot.classList.add("active");
        penColor = dot.dataset.color;
      });
    });

    btnPrev.addEventListener("click", () => setCharByIndex(index - 1));
    btnNext.addEventListener("click", () => setCharByIndex(index + 1));
    btnRandom.addEventListener("click", () => {
      const rnd = Math.floor(Math.random() * list.length);
      setCharByIndex(rnd);
    });
    btnClear.addEventListener("click", clearCanvas);
    btnCheck.addEventListener("click", checkDrawing);

    btnToggleGuide.addEventListener("click", () => {
      showGuide = !showGuide;
      btnToggleGuide.textContent = showGuide ? "üëÅ Vorlage aus" : "üëÅ Vorlage an";
      clearCanvas();
    });

    charSelect.addEventListener("change", () => {
      const i = parseInt(charSelect.value, 10) || 0;
      setCharByIndex(i);
    });

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        setMode(btn.dataset.mode);
      });
    });

    window.addEventListener("resize", resizeCanvas);
    window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 150));

    function init() {
      setMode("upper");
      fillCharSelect();
      setCharByIndex(0);
      resizeCanvas();
    }
    init();
  </script>
</body>
</html>
