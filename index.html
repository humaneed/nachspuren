<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#D4A574">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Alphabet Nachspuren ‚Äì Kidsneed</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --s-1:8px;--s-2:16px;--s-3:24px;--s-4:32px;
      --radius-sm:12px;--radius-md:16px;--radius-lg:24px;
      --shadow-soft:0 2px 10px rgba(45,42,38,.10);
      --bg-canvas:#F5F0E8;--bg-card:#FFFFFF;--bg-muted:#EDE8DC;
      --ink-primary:#2D2A26;--ink-secondary:#6B665C;--ink-light:#9C9588;
      --accent:#D4A574;--accent-light:rgba(212,165,116,.12);--accent-dark:#B48554;
      --color-success:#7BA08A;--color-success-bg:rgba(123,160,138,.15);
      --color-error:#C4726C;--color-error-bg:rgba(196,114,108,.15);
      --text-2xl:24px;--text-xl:20px;--text-lg:18px;--text-md:16px;--text-sm:14px;--text-xs:12px;
      --motion-fast:150ms;--ease-out:cubic-bezier(0.33,1,0.68,1);
      --app-max-w:480px;--font:'Nunito',system-ui,sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg-canvas);color:var(--ink-primary);font-family:var(--font);font-weight:600;font-size:var(--text-md);line-height:1.5;display:flex;align-items:center;justify-content:center;overflow:hidden}

    .app-frame{width:100%;height:100%;background:var(--bg-card);display:flex;flex-direction:column;overflow:hidden}
    @media(min-width:520px){body{padding:var(--s-3)}.app-frame{max-width:var(--app-max-w);height:94dvh;max-height:800px;border:3px solid var(--ink-primary);border-radius:var(--radius-lg);box-shadow:var(--shadow-soft)}}

    /* Header - kompakt */
    header{padding:var(--s-2) var(--s-3);display:flex;align-items:center;justify-content:space-between;border-bottom:3px solid var(--ink-primary);background:var(--bg-card)}
    .brand{font-size:var(--text-lg);font-weight:900}
    .stats{display:flex;gap:var(--s-2);align-items:center}
    .stat{display:flex;align-items:center;gap:4px;font-weight:900;font-size:var(--text-sm)}
    .stat-icon{font-size:16px}

    /* Main */
    .viewport{flex:1;overflow-y:auto;padding:var(--s-2);display:flex;flex-direction:column;gap:var(--s-2)}

    /* Letter Navigation */
    .letter-nav{display:flex;align-items:center;justify-content:center;gap:var(--s-2)}
    .nav-btn{width:48px;height:48px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform var(--motion-fast)}
    .nav-btn:hover{transform:scale(1.05)}
    .nav-btn:active{transform:scale(0.95)}
    .current-letter{font-size:var(--text-2xl);font-weight:900;min-width:80px;text-align:center;padding:var(--s-1) var(--s-2);border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-card)}
    .letter-count{font-size:var(--text-xs);color:var(--ink-secondary);text-align:center;margin-top:4px}

    /* Canvas Area */
    .canvas-container{flex:1;min-height:200px;border:3px solid var(--ink-primary);border-radius:var(--radius-md);overflow:hidden;background:#FFFEF9;position:relative;touch-action:none}
    canvas{display:block;width:100%;height:100%;position:absolute;inset:0}
    #bgCanvas{z-index:1}
    #drawCanvas{z-index:2}

    /* Quick Tools - Floating */
    .quick-tools{position:absolute;top:var(--s-1);right:var(--s-1);display:flex;gap:4px;z-index:10}
    .tool-btn{width:40px;height:40px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-card);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--motion-fast);box-shadow:var(--shadow-soft)}
    .tool-btn:hover{transform:scale(1.05)}
    .tool-btn.active{background:var(--accent);color:white;border-color:var(--accent-dark)}
    .tool-btn.danger{background:var(--color-error-bg);border-color:var(--color-error)}

    /* Color Picker - Floating Bottom */
    .color-bar{position:absolute;bottom:var(--s-1);left:50%;transform:translateX(-50%);display:flex;gap:6px;padding:6px 10px;background:rgba(255,255,255,0.95);border:2px solid var(--ink-primary);border-radius:20px;z-index:10;box-shadow:var(--shadow-soft)}
    .color-dot{width:28px;height:28px;border-radius:50%;border:2px solid var(--ink-primary);cursor:pointer;transition:transform var(--motion-fast)}
    .color-dot:hover{transform:scale(1.15)}
    .color-dot.active{outline:3px solid var(--accent);outline-offset:2px}

    /* Brush Size Slider - Inline */
    .brush-control{display:flex;align-items:center;gap:var(--s-1);padding:0 var(--s-2)}
    .brush-label{font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary)}
    .brush-slider{flex:1;accent-color:var(--accent)}

    /* Main Action Button */
    .main-action{padding:var(--s-2) var(--s-3)}
    
    /* Coverage Display */
    .coverage-display{display:flex;gap:var(--s-3);margin-bottom:var(--s-2);justify-content:center}
    .coverage-item{display:flex;align-items:center;gap:6px;flex:1;max-width:140px}
    .coverage-letter{font-size:var(--text-lg);font-weight:900;min-width:24px;text-align:center}
    .coverage-bar{flex:1;height:12px;background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:6px;overflow:hidden}
    .coverage-fill{height:100%;background:var(--color-error);border-radius:4px;transition:width 0.2s,background 0.3s;width:0}
    .coverage-fill.good{background:var(--color-success)}
    .coverage-pct{font-size:var(--text-xs);font-weight:900;min-width:32px;color:var(--ink-secondary)}
    
    .btn-main{width:100%;min-height:56px;border-radius:var(--radius-md);border:3px solid var(--ink-primary);background:var(--color-success);color:white;font-family:var(--font);font-weight:900;font-size:var(--text-lg);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:var(--s-1);transition:all var(--motion-fast)}
    .btn-main:hover{transform:translateY(-2px);box-shadow:var(--shadow-soft)}
    .btn-main:active{transform:translateY(0)}
    .btn-main.ready{animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}

    /* Feedback Toast */
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--ink-primary);color:white;padding:var(--s-2) var(--s-3);border-radius:var(--radius-md);font-weight:900;font-size:var(--text-sm);opacity:0;transition:all 0.3s var(--ease-out);z-index:100;text-align:center;max-width:90%}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.success{background:var(--color-success)}
    .toast.error{background:var(--color-error)}

    /* Progress Dots */
    .progress-dots{display:flex;justify-content:center;gap:3px;flex-wrap:wrap;padding:var(--s-1)}
    .pdot{width:8px;height:8px;border-radius:50%;background:var(--bg-muted);border:1px solid var(--ink-light)}
    .pdot.done{background:var(--color-success);border-color:var(--color-success)}
    .pdot.current{background:var(--accent);border-color:var(--accent-dark);transform:scale(1.3)}

    /* Toggle Row */
    .toggles{display:flex;justify-content:center;gap:var(--s-3);padding:var(--s-1) 0}
    .toggle-item{display:flex;align-items:center;gap:6px;font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary);cursor:pointer}
    .toggle-box{width:20px;height:20px;border-radius:4px;border:2px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;justify-content:center;font-size:12px;transition:all var(--motion-fast)}
    .toggle-box.on{background:var(--color-success);border-color:var(--color-success);color:white}
  </style>
</head>
<body>
  <div class="app-frame">
    
    <!-- Header -->
    <header>
      <div class="brand">‚úèÔ∏è Buchstaben</div>
      <div class="stats">
        <div class="stat"><span class="stat-icon">‚≠ê</span><span id="coins">0</span></div>
        <div class="stat"><span class="stat-icon">‚úì</span><span id="done-count">0</span>/30</div>
      </div>
    </header>

    <main class="viewport">
      
      <!-- Letter Navigation -->
      <div class="letter-nav">
        <button class="nav-btn" id="prev-btn" type="button">‚óÄ</button>
        <div>
          <div class="current-letter" id="current-letter">A a</div>
          <div class="letter-count" id="letter-num">1 von 30</div>
        </div>
        <button class="nav-btn" id="next-btn" type="button">‚ñ∂</button>
      </div>

      <!-- Progress Dots -->
      <div class="progress-dots" id="progress-dots"></div>

      <!-- Toggles -->
      <div class="toggles">
        <div class="toggle-item" id="toggle-letter">
          <div class="toggle-box on" id="toggle-letter-box">‚úì</div>
          <span>Vorlage</span>
        </div>
        <div class="toggle-item" id="toggle-lines">
          <div class="toggle-box on" id="toggle-lines-box">‚úì</div>
          <span>Linien</span>
        </div>
      </div>

      <!-- Canvas -->
      <div class="canvas-container" id="canvas-container">
        <canvas id="bgCanvas"></canvas>
        <canvas id="drawCanvas"></canvas>
        
        <!-- Quick Tools -->
        <div class="quick-tools">
          <button class="tool-btn" id="undo-btn" type="button" title="R√ºckg√§ngig">‚Ü©</button>
          <button class="tool-btn danger" id="clear-btn" type="button" title="L√∂schen">üóë</button>
        </div>

        <!-- Colors -->
        <div class="color-bar" id="color-bar">
          <div class="color-dot active" data-color="#2D2A26" style="background:#2D2A26"></div>
          <div class="color-dot" data-color="#4A7C91" style="background:#4A7C91"></div>
          <div class="color-dot" data-color="#C4726C" style="background:#C4726C"></div>
          <div class="color-dot" data-color="#7BA08A" style="background:#7BA08A"></div>
          <div class="color-dot" data-color="#D4A574" style="background:#D4A574"></div>
        </div>
      </div>

      <!-- Brush Size -->
      <div class="brush-control">
        <span class="brush-label">Stift:</span>
        <input type="range" class="brush-slider" id="brush-size" min="4" max="24" value="10">
      </div>

    </main>

    <!-- Main Action -->
    <div class="main-action">
      <div class="coverage-display" id="coverage-display">
        <div class="coverage-item">
          <span class="coverage-letter" id="cov-upper">A</span>
          <div class="coverage-bar"><div class="coverage-fill" id="cov-upper-fill"></div></div>
          <span class="coverage-pct" id="cov-upper-pct">0%</span>
        </div>
        <div class="coverage-item">
          <span class="coverage-letter" id="cov-lower">a</span>
          <div class="coverage-bar"><div class="coverage-fill" id="cov-lower-fill"></div></div>
          <span class="coverage-pct" id="cov-lower-pct">0%</span>
        </div>
      </div>
      <button class="btn-main" id="done-btn" type="button">‚úì Fertig ‚Äì Weiter</button>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

  </div>

<script>
(()=>{
  'use strict';
  const $=s=>document.querySelector(s);
  const $$=s=>[...document.querySelectorAll(s)];

  // Storage
  const LS={coins:'kidsneed_coins',done:'kidsneed_alpha_done',idx:'kidsneed_alpha_idx'};
  const getInt=(k,fb=0)=>{try{return parseInt(localStorage.getItem(k),10)||fb}catch{return fb}};
  const setInt=(k,v)=>{try{localStorage.setItem(k,String(v))}catch{}};
  const getSet=(k)=>{try{return new Set(JSON.parse(localStorage.getItem(k)||'[]'))}catch{return new Set()}};
  const setSet=(k,s)=>{try{localStorage.setItem(k,JSON.stringify([...s]))}catch{}};

  // Letters
  const LETTERS=[
    {id:'A',u:'A',l:'a',c:'#D4976A'},{id:'B',u:'B',l:'b',c:'#A67B5B'},{id:'C',u:'C',l:'c',c:'#E8A84C'},
    {id:'D',u:'D',l:'d',c:'#F5C04A'},{id:'E',u:'E',l:'e',c:'#E8D174'},{id:'F',u:'F',l:'f',c:'#8B6B4A'},
    {id:'G',u:'G',l:'g',c:'#6B8E6B'},{id:'H',u:'H',l:'h',c:'#4A8B8B'},{id:'I',u:'I',l:'i',c:'#5BA3A3'},
    {id:'J',u:'J',l:'j',c:'#7B9EB8'},{id:'K',u:'K',l:'k',c:'#5B8B7B'},{id:'L',u:'L',l:'l',c:'#7BA08A'},
    {id:'M',u:'M',l:'m',c:'#C4A864'},{id:'N',u:'N',l:'n',c:'#6B7BA0'},{id:'O',u:'O',l:'o',c:'#8BA0C4'},
    {id:'P',u:'P',l:'p',c:'#7B6B90'},{id:'Q',u:'Q',l:'q',c:'#6B5B80'},{id:'R',u:'R',l:'r',c:'#A06B8B'},
    {id:'S',u:'S',l:'s',c:'#D4A0A0'},{id:'T',u:'T',l:'t',c:'#C4726C'},{id:'U',u:'U',l:'u',c:'#E8A060'},
    {id:'V',u:'V',l:'v',c:'#D4A574'},{id:'W',u:'W',l:'w',c:'#C49840'},{id:'X',u:'X',l:'x',c:'#8090A0'},
    {id:'Y',u:'Y',l:'y',c:'#606B70'},{id:'Z',u:'Z',l:'z',c:'#505860'},{id:'√Ñ',u:'√Ñ',l:'√§',c:'#606060'},
    {id:'√ñ',u:'√ñ',l:'√∂',c:'#707070'},{id:'√ú',u:'√ú',l:'√º',c:'#505050'},{id:'√ü',u:'√ü',l:'√ü',c:'#404040'}
  ];
  const DESCENDERS=new Set(['g','j','p','q','y']);
  const ASCENDERS=new Set(['b','d','f','h','k','l','t','√ü']);

  // State
  const state={
    idx:Math.min(getInt(LS.idx,0),LETTERS.length-1),
    done:getSet(LS.done),
    showLetter:true,
    showLines:true,
    brushColor:'#2D2A26',
    brushSize:10,
    undoStack:[],
    painting:false
  };

  // DOM
  const bgCanvas=$('#bgCanvas');
  const drawCanvas=$('#drawCanvas');
  const container=$('#canvas-container');
  const bgCtx=bgCanvas.getContext('2d');
  const drawCtx=drawCanvas.getContext('2d');
  const toast=$('#toast');

  let dpr=Math.min(2,window.devicePixelRatio||1);

  // Toast
  const showToast=(msg,type='')=>{
    toast.textContent=msg;
    toast.className='toast show'+(type?' '+type:'');
    setTimeout(()=>toast.classList.remove('show'),2000);
  };

  // Update UI
  const updateUI=()=>{
    const letter=LETTERS[state.idx];
    $('#current-letter').textContent=`${letter.u} ${letter.l}`;
    $('#current-letter').style.color=letter.c;
    $('#letter-num').textContent=`${state.idx+1} von ${LETTERS.length}`;
    $('#coins').textContent=getInt(LS.coins,0);
    $('#done-count').textContent=state.done.size;
    
    // Coverage letters
    $('#cov-upper').textContent=letter.u;
    $('#cov-lower').textContent=letter.l;
    $('#cov-upper').style.color=letter.c;
    $('#cov-lower').style.color=letter.c;
    
    // Progress dots
    $('#progress-dots').innerHTML=LETTERS.map((l,i)=>
      `<div class="pdot${state.done.has(l.id)?' done':''}${i===state.idx?' current':''}"></div>`
    ).join('');
  };

  // Canvas setup
  const fitCanvas=()=>{
    const w=container.clientWidth;
    const h=container.clientHeight;
    bgCanvas.width=drawCanvas.width=Math.round(w*dpr);
    bgCanvas.height=drawCanvas.height=Math.round(h*dpr);
  };

  // Render
  const render=()=>{
    fitCanvas();
    const letter=LETTERS[state.idx];
    const cw=bgCanvas.width,ch=bgCanvas.height;
    
    bgCtx.clearRect(0,0,cw,ch);
    bgCtx.fillStyle='#FFFEF9';
    bgCtx.fillRect(0,0,cw,ch);

    const m=15*dpr;
    const topY=ch*0.12,midY=ch*0.42,baseY=ch*0.70,descY=ch*0.90;
    const upperH=baseY-topY,xH=baseY-midY,descH=descY-baseY;

    // Lines
    if(state.showLines){
      bgCtx.lineWidth=2*dpr;
      bgCtx.setLineDash([8*dpr,4*dpr]);
      
      bgCtx.strokeStyle='rgba(123,160,138,0.6)';
      bgCtx.beginPath();bgCtx.moveTo(m,topY);bgCtx.lineTo(cw-m,topY);bgCtx.stroke();
      
      bgCtx.strokeStyle='rgba(74,124,145,0.6)';
      bgCtx.beginPath();bgCtx.moveTo(m,midY);bgCtx.lineTo(cw-m,midY);bgCtx.stroke();
      
      bgCtx.setLineDash([]);
      bgCtx.strokeStyle='rgba(196,114,108,0.85)';
      bgCtx.lineWidth=3*dpr;
      bgCtx.beginPath();bgCtx.moveTo(m,baseY);bgCtx.lineTo(cw-m,baseY);bgCtx.stroke();
      
      bgCtx.strokeStyle='rgba(0,0,0,0.15)';
      bgCtx.lineWidth=1.5*dpr;
      bgCtx.setLineDash([5*dpr,3*dpr]);
      bgCtx.beginPath();bgCtx.moveTo(m,descY);bgCtx.lineTo(cw-m,descY);bgCtx.stroke();
    }

    // Letter
    if(state.showLetter){
      bgCtx.setLineDash([]);
      bgCtx.textAlign='center';
      bgCtx.textBaseline='alphabetic';
      bgCtx.fillStyle=letter.c+'77';
      bgCtx.strokeStyle=letter.c;
      bgCtx.lineWidth=2.5*dpr;

      // Upper
      const uSize=upperH*1.0;
      bgCtx.font=`700 ${uSize}px Nunito,sans-serif`;
      bgCtx.fillText(letter.u,cw*0.3,baseY);
      bgCtx.strokeText(letter.u,cw*0.3,baseY);

      // Lower
      let lSize;
      if(ASCENDERS.has(letter.l))lSize=upperH*1.0;
      else if(DESCENDERS.has(letter.l))lSize=(xH+descH)*0.9;
      else lSize=xH*1.35;
      
      bgCtx.font=`700 ${lSize}px Nunito,sans-serif`;
      bgCtx.fillText(letter.l,cw*0.7,baseY);
      bgCtx.strokeText(letter.l,cw*0.7,baseY);
    }

    clearDraw();
    updateUI();
  };

  // Drawing
  const clearDraw=()=>{
    drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    state.undoStack=[];
    // Reset coverage display
    $('#cov-upper-fill').style.width='0%';
    $('#cov-lower-fill').style.width='0%';
    $('#cov-upper-fill').classList.remove('good');
    $('#cov-lower-fill').classList.remove('good');
    $('#cov-upper-pct').textContent='0%';
    $('#cov-lower-pct').textContent='0%';
    $('#done-btn').classList.remove('ready');
  };

  const pushUndo=()=>{
    state.undoStack.push(drawCtx.getImageData(0,0,drawCanvas.width,drawCanvas.height));
    if(state.undoStack.length>10)state.undoStack.shift();
  };

  const setBrush=()=>{
    drawCtx.lineCap='round';
    drawCtx.lineJoin='round';
    drawCtx.lineWidth=state.brushSize*dpr;
    drawCtx.strokeStyle=state.brushColor;
  };

  const getPos=e=>{
    const r=drawCanvas.getBoundingClientRect();
    return{x:(e.clientX-r.left)*dpr,y:(e.clientY-r.top)*dpr};
  };

  drawCanvas.addEventListener('pointerdown',e=>{
    drawCanvas.setPointerCapture(e.pointerId);
    state.painting=true;
    pushUndo();
    setBrush();
    const p=getPos(e);
    drawCtx.beginPath();
    drawCtx.moveTo(p.x,p.y);
    drawCtx.lineTo(p.x+0.1,p.y);
    drawCtx.stroke();
  });

  drawCanvas.addEventListener('pointermove',e=>{
    if(!state.painting)return;
    const p=getPos(e);
    drawCtx.lineTo(p.x,p.y);
    drawCtx.stroke();
    drawCtx.beginPath();
    drawCtx.moveTo(p.x,p.y);
  });

  const endDraw=()=>{
    if(state.painting){
      state.painting=false;
      updateCoverage(); // Update when stroke ends
    }
  };
  drawCanvas.addEventListener('pointerup',endDraw);
  drawCanvas.addEventListener('pointercancel',endDraw);
  drawCanvas.addEventListener('pointerleave',endDraw);

  // ===== RICHTIGKEITSPR√úFUNG =====
  // Pr√ºft ob mindestens 70% der Buchstaben-Pixel √ºberdeckt wurden
  
  const getLetterMask=()=>{
    // Tempor√§res Canvas f√ºr Buchstaben-Maske (nur die Buchstaben, keine Linien)
    const tempCanvas=document.createElement('canvas');
    tempCanvas.width=bgCanvas.width;
    tempCanvas.height=bgCanvas.height;
    const tempCtx=tempCanvas.getContext('2d');
    
    const letter=LETTERS[state.idx];
    const cw=tempCanvas.width,ch=tempCanvas.height;
    
    const topY=ch*0.12,midY=ch*0.42,baseY=ch*0.70,descY=ch*0.90;
    const upperH=baseY-topY,xH=baseY-midY,descH=descY-baseY;
    
    tempCtx.fillStyle='#000000';
    tempCtx.textAlign='center';
    tempCtx.textBaseline='alphabetic';
    
    // Gro√übuchstabe
    const uSize=upperH*1.0;
    tempCtx.font=`700 ${uSize}px Nunito,sans-serif`;
    tempCtx.fillText(letter.u,cw*0.3,baseY);
    
    // Kleinbuchstabe
    let lSize;
    if(ASCENDERS.has(letter.l))lSize=upperH*1.0;
    else if(DESCENDERS.has(letter.l))lSize=(xH+descH)*0.9;
    else lSize=xH*1.35;
    
    tempCtx.font=`700 ${lSize}px Nunito,sans-serif`;
    tempCtx.fillText(letter.l,cw*0.7,baseY);
    
    return tempCtx.getImageData(0,0,cw,ch);
  };
  
  const checkAccuracy=()=>{
    const cw=drawCanvas.width,ch=drawCanvas.height;
    
    // Buchstaben-Maske holen
    const maskData=getLetterMask().data;
    
    // Zeichnung holen
    const drawData=drawCtx.getImageData(0,0,cw,ch).data;
    
    // Z√§hle Buchstaben-Pixel und √ºberlappende Pixel
    // Teile in links (Gro√übuchstabe) und rechts (Kleinbuchstabe)
    const midX=cw*0.5;
    
    let upperTotal=0,upperCovered=0;
    let lowerTotal=0,lowerCovered=0;
    
    for(let y=0;y<ch;y++){
      for(let x=0;x<cw;x++){
        const i=(y*cw+x)*4;
        const maskAlpha=maskData[i+3]; // Alpha des Buchstabens
        
        if(maskAlpha>50){ // Ist Teil des Buchstabens
          const drawAlpha=drawData[i+3]; // Alpha der Zeichnung
          const isCovered=drawAlpha>30; // Wurde hier gezeichnet?
          
          if(x<midX){
            // Gro√übuchstabe (links)
            upperTotal++;
            if(isCovered)upperCovered++;
          }else{
            // Kleinbuchstabe (rechts)
            lowerTotal++;
            if(isCovered)lowerCovered++;
          }
        }
      }
    }
    
    // Prozentsatz berechnen
    const upperPercent=upperTotal>0?(upperCovered/upperTotal)*100:0;
    const lowerPercent=lowerTotal>0?(lowerCovered/lowerTotal)*100:0;
    
    return{
      upperPercent:Math.round(upperPercent),
      lowerPercent:Math.round(lowerPercent),
      upperOk:upperPercent>=70,
      lowerOk:lowerPercent>=70,
      bothOk:upperPercent>=70&&lowerPercent>=70
    };
  };

  // Update coverage display
  const updateCoverage=()=>{
    const result=checkAccuracy();
    const letter=LETTERS[state.idx];
    
    $('#cov-upper').textContent=letter.u;
    $('#cov-lower').textContent=letter.l;
    $('#cov-upper').style.color=letter.c;
    $('#cov-lower').style.color=letter.c;
    
    $('#cov-upper-fill').style.width=Math.min(100,result.upperPercent)+'%';
    $('#cov-lower-fill').style.width=Math.min(100,result.lowerPercent)+'%';
    $('#cov-upper-fill').classList.toggle('good',result.upperOk);
    $('#cov-lower-fill').classList.toggle('good',result.lowerOk);
    
    $('#cov-upper-pct').textContent=result.upperPercent+'%';
    $('#cov-lower-pct').textContent=result.lowerPercent+'%';
    
    // Button visuell hervorheben wenn fertig
    $('#done-btn').classList.toggle('ready',result.bothOk);
  };

  // Events
  $('#prev-btn').onclick=()=>{state.idx=(state.idx-1+LETTERS.length)%LETTERS.length;setInt(LS.idx,state.idx);render()};
  $('#next-btn').onclick=()=>{state.idx=(state.idx+1)%LETTERS.length;setInt(LS.idx,state.idx);render()};

  $('#undo-btn').onclick=()=>{
    if(state.undoStack.length){
      drawCtx.putImageData(state.undoStack.pop(),0,0);
      updateCoverage();
    }
  };

  $('#clear-btn').onclick=()=>{
    clearDraw();
    showToast('üßº Gel√∂scht');
  };

  $('#toggle-letter').onclick=()=>{
    state.showLetter=!state.showLetter;
    $('#toggle-letter-box').classList.toggle('on',state.showLetter);
    $('#toggle-letter-box').textContent=state.showLetter?'‚úì':'';
    render();
  };

  $('#toggle-lines').onclick=()=>{
    state.showLines=!state.showLines;
    $('#toggle-lines-box').classList.toggle('on',state.showLines);
    $('#toggle-lines-box').textContent=state.showLines?'‚úì':'';
    render();
  };

  $$('.color-dot').forEach(dot=>{
    dot.onclick=()=>{
      $$('.color-dot').forEach(d=>d.classList.remove('active'));
      dot.classList.add('active');
      state.brushColor=dot.dataset.color;
    };
  });

  $('#brush-size').oninput=e=>{
    state.brushSize=parseInt(e.target.value,10);
  };

  $('#done-btn').onclick=()=>{
    const result=checkAccuracy();
    const letter=LETTERS[state.idx];
    
    // Pr√ºfe ob beide Buchstaben zu mindestens 70% nachgespurt
    if(!result.bothOk){
      let msg='';
      if(!result.upperOk&&!result.lowerOk){
        msg=`‚úèÔ∏è Spur beide Buchstaben nach!\n${letter.u}: ${result.upperPercent}% | ${letter.l}: ${result.lowerPercent}%`;
      }else if(!result.upperOk){
        msg=`‚úèÔ∏è ${letter.u} fehlt noch! (${result.upperPercent}% von 70%)`;
      }else{
        msg=`‚úèÔ∏è ${letter.l} fehlt noch! (${result.lowerPercent}% von 70%)`;
      }
      showToast(msg,'error');
      return;
    }
    
    // Erfolgreich!
    const isNew=!state.done.has(letter.id);
    
    if(isNew){
      state.done.add(letter.id);
      setSet(LS.done,state.done);
      const coins=getInt(LS.coins,0)+1;
      setInt(LS.coins,coins);
      showToast(`‚≠ê ${letter.u}${letter.l} geschafft! +1`,'success');
    }else{
      showToast(`‚ú® ${letter.u}${letter.l} ge√ºbt!`,'success');
    }
    
    // Next letter
    setTimeout(()=>{
      state.idx=(state.idx+1)%LETTERS.length;
      setInt(LS.idx,state.idx);
      render();
    },1000);
  };

  // Resize
  window.addEventListener('resize',()=>{
    dpr=Math.min(2,window.devicePixelRatio||1);
    render();
  });

  // Init
  render();
  console.log('‚úÖ Alphabet Nachspuren v3');
})();
</script>
</body>
</html>
