<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#7BA591">
  <title>Mein ABC ‚Ä¢ Schreiben lernen</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --color-primary: #7BA591;
      --color-primary-dark: #5D8A75;
      --color-primary-light: #A8C9B8;
      --color-accent: #E8B86D;
      --color-accent-dark: #D4A055;
      --color-success: #88B894;
      --color-error: #D4816F;
      --color-text: #3D4F42;
      --color-text-light: #6B7C70;
      --color-bg: #F9F7F4;
      --color-surface: #FFFFFF;
      --color-border: #E3DED7;
      --shadow-sm: 0 1px 3px rgba(61, 79, 66, 0.05);
      --shadow-md: 0 2px 6px rgba(61, 79, 66, 0.08);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.15s ease;
      --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'Roboto', sans-serif;
    }

    html {
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-body);
      background: var(--color-bg);
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      padding: 0;
      color: var(--color-text);
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .app-wrapper {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-width: 600px;
      margin: 0 auto;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
    }

    @media (min-width: 600px) {
      .container {
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      background: var(--color-surface);
      padding: 12px;
      padding-top: calc(12px + env(safe-area-inset-top));
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
      border-bottom: 1px solid var(--color-border);
    }

    @media (min-width: 600px) {
      .header {
        padding: 16px;
        padding-top: calc(16px + env(safe-area-inset-top));
        gap: 12px;
      }
    }

    .logo {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--color-primary-dark);
      white-space: nowrap;
      letter-spacing: -0.02em;
      font-family: var(--font-display);
    }

    @media (min-width: 600px) {
      .logo {
        font-size: 1.35rem;
      }
    }

    .mode-toggle {
      display: inline-flex;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      overflow: hidden;
      font-size: 0.75rem;
      background: var(--color-surface);
    }

    .mode-btn {
      border: none;
      padding: 5px 10px;
      background: transparent;
      color: var(--color-text-light);
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      min-height: 32px;
    }

    .mode-btn.active {
      background: var(--color-primary);
      color: var(--color-surface);
    }

    .card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
      margin-bottom: 12px;
    }

    @media (min-width: 600px) {
      .card {
        padding: 20px;
        margin-bottom: 16px;
      }
    }

    .current-letter {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 12px;
      text-align: center;
      letter-spacing: 0.15em;
      font-family: var(--font-display);
      line-height: 1.2;
    }

    @media (min-width: 600px) {
      .current-letter {
        font-size: 2.5rem;
        letter-spacing: 0.2em;
      }
    }

    .controls-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-light);
      font-weight: 600;
    }

    .select {
      padding: 5px 10px;
      font-size: 0.8rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text);
      font-weight: 500;
      min-height: 32px;
    }

    @media (min-width: 600px) {
      .select {
        padding: 6px 12px;
        font-size: 0.85rem;
      }
    }

    .color-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .color-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
    }

    .color-dot.active {
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
    }

    .canvas-wrap {
      position: relative;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: var(--color-primary-dark);
      overflow: hidden;
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      aspect-ratio: 5 / 2;
    }

    #traceCanvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
      background: transparent;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1 1 0;
      min-width: 0;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      padding: 10px 14px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: var(--color-surface);
      color: var(--color-text);
      transition: var(--transition);
      min-height: 44px;
    }

    @media (min-width: 600px) {
      .btn {
        padding: 12px 16px;
        font-size: 0.85rem;
      }
    }

    .btn:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }

    .btn-accent {
      background: var(--color-accent);
      color: var(--color-text);
      border-color: var(--color-accent-dark);
    }

    .btn-check {
      background: var(--color-success);
      color: var(--color-text);
      border-color: var(--color-primary);
    }

    .hint-row {
      margin-bottom: 8px;
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--color-text-light);
    }

    .hint-strong {
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .feedback-box {
      padding: 12px;
      border-radius: var(--radius-md);
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      min-height: 60px;
      margin-bottom: 12px;
      transition: var(--transition);
    }

    .feedback-box.hidden {
      display: none;
    }

    .feedback-box.success {
      background: #e4fbe9;
      border-color: var(--color-success);
    }

    .feedback-box.partial {
      background: #fff4e6;
      border-color: var(--color-accent);
    }

    .feedback-box.try-again {
      background: #fee2e2;
      border-color: var(--color-error);
    }

    .feedback-title {
      font-size: 0.9rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--color-text);
      margin-bottom: 6px;
    }

    .feedback-text {
      font-size: 0.8rem;
      line-height: 1.5;
      color: var(--color-text-light);
    }

    .score-bar {
      margin-top: 8px;
      height: 6px;
      background: var(--color-border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .score-fill {
      height: 100%;
      background: var(--color-primary);
      border-radius: var(--radius-sm);
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <div class="header">
      <div class="logo">‚úèÔ∏è Mein ABC</div>
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="upper">ABC</button>
        <button class="mode-btn" data-mode="lower">abc</button>
        <button class="mode-btn" data-mode="digits">123</button>
      </div>
    </div>

    <div class="container">
      <div class="card">
        <div class="current-letter" id="currentPair">A a</div>

        <div class="controls-row">
          <span class="label">Zeichen</span>
          <select id="charSelect" class="select"></select>
        </div>

        <div class="color-row">
          <span class="label">Farbe</span>
          <button class="color-dot" data-color="#FBBF24" style="background:#FBBF24;"></button>
          <button class="color-dot active" data-color="#F3F4F6" style="background:#F3F4F6;"></button>
          <button class="color-dot" data-color="#60A5FA" style="background:#60A5FA;"></button>
          <button class="color-dot" data-color="#FB923C" style="background:#FB923C;"></button>
          <button class="color-dot" data-color="#88B894" style="background:#88B894;"></button>
          <button class="color-dot" data-color="#F472B6" style="background:#F472B6;"></button>
        </div>
      </div>

      <div class="canvas-wrap">
        <canvas id="traceCanvas" width="1000" height="400"></canvas>
      </div>

      <div class="buttons-row">
        <button id="btnPrev" class="btn">‚¨ÖÔ∏è Zur√ºck</button>
        <button id="btnRandom" class="btn btn-accent">üé≤ Zufall</button>
        <button id="btnNext" class="btn">Weiter ‚û°Ô∏è</button>
      </div>
      
      <div class="buttons-row">
        <button id="btnClear" class="btn">üßΩ L√∂schen</button>
        <button id="btnCheck" class="btn btn-check">‚úì Pr√ºfen</button>
        <button id="btnToggleGuide" class="btn">üëÅ Vorlage aus</button>
      </div>

      <div id="feedbackBox" class="feedback-box hidden">
        <div class="feedback-title" id="feedbackTitle"></div>
        <div class="feedback-text" id="feedbackText"></div>
        <div class="score-bar">
          <div class="score-fill" id="scoreFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="card hint-row">
        <div id="exampleHint" class="hint-strong"></div>
        <div id="tipHint"></div>
      </div>
    </div>
  </div>

  <script>
    const UPPER = "A√ÑBCDEFGHIJKLMNO√ñPQRSTUVW√úXYZ".split("");
    const LOWER = "a√§bcdefghijklmno√∂pqrstuvw√ºxyz√ü".split("");
    const DIGITS = "0123456789".split("");

    const ASCENDERS = new Set(['b', 'd', 'f', 'h', 'k', 'l', 't', '√ü']);
    const DESCENDERS = new Set(['g', 'j', 'p', 'q', 'y']);
    const DOTS_ABOVE = new Set(['√Ñ', '√ñ', '√ú', '√§', '√∂', '√º', 'i', 'j']);

    const LETTER_EXAMPLES = {
      A: "A wie Apfel", √Ñ: "√Ñ wie √Ñpfel",
      B: "B wie Ball", C: "C wie Computer",
      D: "D wie Dinosaurier", E: "E wie Esel",
      F: "F wie Fisch", G: "G wie Gitarre",
      H: "H wie Herz", I: "I wie Igel",
      J: "J wie Jacke", K: "K wie Kerze",
      L: "L wie Leiter", M: "M wie Haus",
      N: "N wie Nagel", O: "O wie Ofen", √ñ: "√ñ wie √ñfen",
      P: "P wie Palme", Q: "Q wie Qualle",
      R: "R wie Rakete", S: "S wie Sonne",
      T: "T wie Tiger", U: "U wie Uhr", √ú: "√ú wie √úbung",
      V: "V wie Vogel", W: "W wie Wolke",
      X: "X wie Xylophon", Y: "Y wie Yacht",
      Z: "Z wie Zeit"
    };

    const DIGIT_EXAMPLES = {
      0: "0 ‚Äì Ein runder Kreis.",
      1: "1 ‚Äì Ein Strich, ein Finger.",
      2: "2 ‚Äì Zwei Augen, zwei Schuhe.",
      3: "3 ‚Äì Drei Schritte.",
      4: "4 ‚Äì Vier R√§der am Auto.",
      5: "5 ‚Äì F√ºnf Finger an der Hand.",
      6: "6 ‚Äì Sechs Bausteine.",
      7: "7 ‚Äì Sieben Wochentage.",
      8: "8 ‚Äì Wie ein Schneemann.",
      9: "9 ‚Äì Neun Punkte."
    };

    const modeButtons = Array.from(document.querySelectorAll(".mode-btn"));
    const charSelect = document.getElementById("charSelect");
    const currentPair = document.getElementById("currentPair");
    const canvas = document.getElementById("traceCanvas");
    const ctx = canvas.getContext("2d");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnRandom = document.getElementById("btnRandom");
    const btnClear = document.getElementById("btnClear");
    const btnCheck = document.getElementById("btnCheck");
    const btnToggleGuide = document.getElementById("btnToggleGuide");
    const colorDots = Array.from(document.querySelectorAll(".color-dot"));
    const exampleHint = document.getElementById("exampleHint");
    const tipHint = document.getElementById("tipHint");
    const feedbackBox = document.getElementById("feedbackBox");
    const feedbackTitle = document.getElementById("feedbackTitle");
    const feedbackText = document.getElementById("feedbackText");
    const scoreFill = document.getElementById("scoreFill");

    let mode = "upper";
    let list = UPPER;
    let index = 0;
    let currentChar = "A";
    let penColor = "#F3F4F6";
    let drawing = false;
    let lastX = 0;
    let lastY = 0;
    let showGuide = true;

    function setMode(newMode) {
      mode = newMode;
      if (mode === "upper") list = UPPER;
      else if (mode === "lower") list = LOWER;
      else list = DIGITS;

      modeButtons.forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });

      fillCharSelect();
      setCharByIndex(0);
    }

    function fillCharSelect() {
      charSelect.innerHTML = "";
      list.forEach((ch, i) => {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = ch;
        charSelect.appendChild(opt);
      });
    }

    function setCharByIndex(i) {
      if (!list.length) return;
      if (i < 0) i = list.length - 1;
      if (i >= list.length) i = 0;
      index = i;
      currentChar = list[index];
      charSelect.value = String(index);

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();

      if (mode === "upper") {
        currentPair.textContent = up + " " + low;
      } else if (mode === "lower") {
        currentPair.textContent = up + " " + low;
      } else {
        currentPair.textContent = currentChar;
      }

      updateHints();
      hideFeedback();
      clearCanvas();
    }

    function updateHints() {
      if (mode === "digits") {
        exampleHint.textContent = DIGIT_EXAMPLES[currentChar] || ("Zahl " + currentChar + " schreiben √ºben.");
        tipHint.textContent = "Sprich die Zahl laut aus und betrachte ihre Form genau. Fahre sie dann langsam mit dem Finger nach.";
      } else {
        const upper = currentChar.toUpperCase();
        const base = LETTER_EXAMPLES[upper] || (upper + " schreiben √ºben.");
        exampleHint.textContent = base;
        tipHint.textContent = "Schau dir beide Buchstaben an: Wo beginnen sie? Spure dann langsam nach ‚Äì erst den gro√üen, dann den kleinen Buchstaben.";
      }
    }

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;

      canvas.width = rect.width * ratio;
      canvas.height = rect.height * ratio;

      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      clearCanvas();
    }

    function clearCanvas() {
      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      ctx.clearRect(0, 0, w, h);
      drawGuidelinesAndLetter();
      hideFeedback();
    }

    function drawGuidelinesAndLetter() {
      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      if (!w || !h) return;

      ctx.save();
      
      // Schullineatur nach Poster-Vorbild
      // Verh√§ltnis: Oberl√§nge 1.5 : x-H√∂he 1 : Unterl√§nge 1
      const totalHeight = h * 0.62; // Gesamth√∂he des Lineatur-Systems
      const xHeight = totalHeight / 3.5; // x-H√∂he als Basis
      
      const centerY = h * 0.5;
      
      // Pr√§zise Linienpositionierung
      const lineAscender = centerY - (xHeight * 1.5) - (xHeight * 0.5); // Oberl√§ngen-Linie
      const lineMiddle = centerY - (xHeight * 0.5);                     // Mittellinie (x-H√∂he oben)
      const lineBase = centerY + (xHeight * 0.5);                       // Grundlinie
      const lineDescender = lineBase + xHeight;                          // Unterl√§ngen-Linie

      const xLeft = w * 0.06;
      const xRight = w * 0.94;

      // Oberl√§ngen-Linie (dezent gestrichelt)
      ctx.strokeStyle = "rgba(168, 201, 184, 0.25)";
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 4]);
      ctx.beginPath();
      ctx.moveTo(xLeft, lineAscender);
      ctx.lineTo(xRight, lineAscender);
      ctx.stroke();
      
      // Mittellinie (gestrichelt)
      ctx.strokeStyle = "rgba(168, 201, 184, 0.35)";
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 3]);
      ctx.beginPath();
      ctx.moveTo(xLeft, lineMiddle);
      ctx.lineTo(xRight, lineMiddle);
      ctx.stroke();
      
      // Grundlinie (durchgezogen, betont)
      ctx.strokeStyle = "rgba(168, 201, 184, 0.5)";
      ctx.lineWidth = 1.8;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(xLeft, lineBase);
      ctx.lineTo(xRight, lineBase);
      ctx.stroke();
      
      // Unterl√§ngen-Linie (dezent gestrichelt)
      ctx.strokeStyle = "rgba(168, 201, 184, 0.25)";
      ctx.lineWidth = 1;
      ctx.setLineDash([3, 4]);
      ctx.beginPath();
      ctx.moveTo(xLeft, lineDescender);
      ctx.lineTo(xRight, lineDescender);
      ctx.stroke();

      // Vertikale Hilfslinie links (sehr dezent)
      ctx.setLineDash([2, 5]);
      ctx.lineWidth = 0.8;
      ctx.strokeStyle = "rgba(168, 201, 184, 0.2)";
      ctx.beginPath();
      ctx.moveTo(w * 0.12, lineAscender - xHeight * 0.15);
      ctx.lineTo(w * 0.12, lineDescender + xHeight * 0.15);
      ctx.stroke();
      
      ctx.restore();

      if (!showGuide || !currentChar) return;

      ctx.save();
      const isDigit = mode === "digits";

      if (isDigit) {
        // Ziffern: von Oberl√§ngen-Linie bis Grundlinie (wie Gro√übuchstaben)
        const digitHeight = lineBase - lineAscender;
        const fontSize = digitHeight * 0.88;
        ctx.font = `700 ${fontSize}px Arial, sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillStyle = "rgba(168, 201, 184, 0.22)";
        ctx.fillText(currentChar, w * 0.5, lineBase);
      } else {
        const up = currentChar.toUpperCase();
        const low = currentChar.toLowerCase();

        // Gro√übuchstaben: von Oberl√§ngen-Linie bis Grundlinie
        const upperHeight = lineBase - lineAscender;
        const upperFontSize = upperHeight * 0.88;

        ctx.font = `700 ${upperFontSize}px Arial, sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillStyle = "rgba(168, 201, 184, 0.22)";

        // Position Gro√übuchstabe: 32% von links
        const upperX = w * 0.32;
        ctx.fillText(up, upperX, lineBase);

        // Kleinbuchstaben: abh√§ngig von Ober-/Unterl√§ngen
        let lowerFontSize, lowerBaseline;

        if (ASCENDERS.has(low)) {
          // Buchstaben mit Oberl√§ngen: von Oberl√§ngen-Linie bis Grundlinie
          const ascenderHeight = lineBase - lineAscender;
          lowerFontSize = ascenderHeight * 0.88;
          lowerBaseline = lineBase;
        } else if (DESCENDERS.has(low)) {
          // Buchstaben mit Unterl√§ngen: von Mittellinie bis Unterl√§ngen-Linie
          const descenderHeight = lineDescender - lineMiddle;
          lowerFontSize = descenderHeight * 0.88;
          lowerBaseline = lineDescender;
        } else {
          // Normale Kleinbuchstaben: x-H√∂he (Mittellinie bis Grundlinie)
          const normalHeight = lineBase - lineMiddle;
          lowerFontSize = normalHeight * 0.88;
          lowerBaseline = lineBase;
        }

        ctx.font = `700 ${lowerFontSize}px Arial, sans-serif`;
        // Position Kleinbuchstabe: 68% von links (guter Abstand zum Gro√übuchstaben)
        const lowerX = w * 0.68;
        ctx.fillText(low, lowerX, lowerBaseline);
      }

      ctx.restore();
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches[0]) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }

    function startDraw(e) {
      e.preventDefault();
      const pos = getPos(e);
      drawing = true;
      lastX = pos.x;
      lastY = pos.y;
    }

    function moveDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      const width = canvas.clientWidth || 300;
      const base = 0.010; // Etwas d√ºnner f√ºr pr√§ziseres Schreiben
      ctx.lineWidth = Math.max(width * base, 2.5);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.strokeStyle = penColor;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      lastX = pos.x;
      lastY = pos.y;
    }

    function endDraw(e) {
      if (!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", moveDraw);
    window.addEventListener("mouseup", endDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: false });
    canvas.addEventListener("touchmove", moveDraw, { passive: false });
    canvas.addEventListener("touchend", endDraw, { passive: false });
    canvas.addEventListener("touchcancel", endDraw, { passive: false });

    function checkDrawing() {
      const refCanvas = createReferenceCanvas();
      const userCanvas = canvas;
      const refData = analyzeCanvas(refCanvas);
      const userData = analyzeCanvas(userCanvas);
      const score = compareDrawings(refData, userData);
      showFeedback(score);
    }

    function createReferenceCanvas() {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');

      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      tempCanvas.width = w;
      tempCanvas.height = h;

      // Gleiche pr√§zise Proportionen wie in drawGuidelinesAndLetter
      const totalHeight = h * 0.62;
      const xHeight = totalHeight / 3.5;
      
      const centerY = h * 0.5;
      
      const lineAscender = centerY - (xHeight * 1.5) - (xHeight * 0.5);
      const lineMiddle = centerY - (xHeight * 0.5);
      const lineBase = centerY + (xHeight * 0.5);
      const lineDescender = lineBase + xHeight;

      const isDigit = mode === "digits";

      if (isDigit) {
        const digitHeight = lineBase - lineAscender;
        const fontSize = digitHeight * 0.88;
        tempCtx.font = `700 ${fontSize}px Arial, sans-serif`;
        tempCtx.textAlign = "center";
        tempCtx.textBaseline = "alphabetic";
        tempCtx.fillStyle = "#ffffff";
        tempCtx.fillText(currentChar, w * 0.5, lineBase);
      } else {
        const up = currentChar.toUpperCase();
        const low = currentChar.toLowerCase();
        
        const upperHeight = lineBase - lineAscender;
        const upperFontSize = upperHeight * 0.88;

        tempCtx.font = `700 ${upperFontSize}px Arial, sans-serif`;
        tempCtx.textAlign = "center";
        tempCtx.textBaseline = "alphabetic";
        tempCtx.fillStyle = "#ffffff";
        tempCtx.fillText(up, w * 0.32, lineBase);

        let lowerFontSize, lowerBaseline;
        
        if (ASCENDERS.has(low)) {
          const ascenderHeight = lineBase - lineAscender;
          lowerFontSize = ascenderHeight * 0.88;
          lowerBaseline = lineBase;
        } else if (DESCENDERS.has(low)) {
          const descenderHeight = lineDescender - lineMiddle;
          lowerFontSize = descenderHeight * 0.88;
          lowerBaseline = lineDescender;
        } else {
          const normalHeight = lineBase - lineMiddle;
          lowerFontSize = normalHeight * 0.88;
          lowerBaseline = lineBase;
        }

        tempCtx.font = `700 ${lowerFontSize}px Arial, sans-serif`;
        tempCtx.fillText(low, w * 0.68, lowerBaseline);
      }

      return tempCanvas;
    }

    function analyzeCanvas(cnv) {
      const ctx = cnv.getContext('2d');
      const w = cnv.width;
      const h = cnv.height;
      const imageData = ctx.getImageData(0, 0, w, h);
      const pixels = imageData.data;

      let filledPixels = 0;
      let minX = w, maxX = 0, minY = h, maxY = 0;
      const regions = { top: 0, middle: 0, bottom: 0, left: 0, right: 0, center: 0 };
      let topQuarterPixels = 0;
      const topQuarterLimit = h * 0.25;

      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          const idx = (y * w + x) * 4;
          const alpha = pixels[idx + 3];

          if (alpha > 50) {
            filledPixels++;

            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;

            if (y < topQuarterLimit) {
              topQuarterPixels++;
            }

            if (y < h * 0.33) regions.top++;
            else if (y > h * 0.66) regions.bottom++;
            else regions.middle++;

            if (x < w * 0.33) regions.left++;
            else if (x > w * 0.66) regions.right++;
            else regions.center++;
          }
        }
      }

      const boundingWidth = maxX - minX;
      const boundingHeight = maxY - minY;
      const coverage = filledPixels / (w * h);

      return {
        filledPixels,
        coverage,
        boundingWidth,
        boundingHeight,
        centerX: (minX + maxX) / 2,
        centerY: (minY + maxY) / 2,
        regions,
        width: w,
        height: h,
        topQuarterPixels,
        topQuarterRatio: filledPixels ? topQuarterPixels / filledPixels : 0
      };
    }

    function compareDrawings(refData, userData) {
      let score = 0;
      const maxScore = 100;

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();
      const hasDots = DOTS_ABOVE.has(up) || DOTS_ABOVE.has(low);

      if (userData.filledPixels < 100) return 0;
      const drawingAmount = Math.min(1, userData.filledPixels / 200);
      score += drawingAmount * 15;

      const coveragePoints = hasDots ? 20 : 25;
      const coverageRatio = userData.coverage / refData.coverage;
      if (coverageRatio >= 0.5 && coverageRatio <= 2.0) {
        const deviation = Math.abs(1 - coverageRatio);
        if (deviation < 0.3) {
          score += coveragePoints * (1 - deviation / 0.3);
        } else {
          score += coveragePoints * Math.max(0, (0.5 - deviation) / 0.2);
        }
      }

      if (hasDots) {
        const refTopRatio = refData.topQuarterRatio;
        const userTopRatio = userData.topQuarterRatio;
        const topDiff = Math.abs(refTopRatio - userTopRatio);

        if (topDiff < 0.05) {
          score += 10;
        } else if (topDiff < 0.1) {
          score += 7;
        } else if (topDiff < 0.15) {
          score += 4;
        }
      } else {
        score += 5;
      }

      const centerDiffX = Math.abs(userData.centerX - refData.centerX);
      const centerDiffY = Math.abs(userData.centerY - refData.centerY);
      const maxCenterDiff = Math.max(userData.width, userData.height) * 0.2;
      const totalCenterDiff = (centerDiffX + centerDiffY) / maxCenterDiff;

      if (totalCenterDiff < 0.5) {
        score += 30 * (1 - totalCenterDiff / 0.5);
      } else if (totalCenterDiff < 1.0) {
        score += 30 * Math.max(0, (1.0 - totalCenterDiff) / 0.5) * 0.3;
      }

      let regionScore = 0;
      const regionKeys = ['top', 'middle', 'bottom', 'left', 'right', 'center'];

      regionKeys.forEach(key => {
        const refRatio = refData.regions[key] / refData.filledPixels || 0;
        const userRatio = userData.regions[key] / userData.filledPixels || 0;
        const diff = Math.abs(refRatio - userRatio);

        if (diff < 0.1) {
          regionScore += 1 - (diff / 0.1);
        } else if (diff < 0.2) {
          regionScore += (0.2 - diff) / 0.1 * 0.2;
        }
      });

      score += (regionScore / regionKeys.length) * 20;

      return Math.min(maxScore, Math.max(0, score));
    }

    function showFeedback(score) {
      feedbackBox.classList.remove('hidden', 'success', 'partial', 'try-again');

      const up = currentChar.toUpperCase();
      const low = currentChar.toLowerCase();
      const hasDots = DOTS_ABOVE.has(up) || DOTS_ABOVE.has(low);

      let emoji, title, text, cssClass;

      if (score >= 85) {
        emoji = "üåü";
        title = "Perfekt!";
        text = hasDots
          ? "Super! Du hast den Buchstaben sehr genau nachgespurt. Die Punkte oben sind auch richtig!"
          : "Super! Du hast den Buchstaben sehr genau nachgespurt und gut auf die Linien geachtet.";
        cssClass = "success";
      } else if (score >= 70) {
        emoji = "‚≠ê";
        title = "Sehr gut!";
        text = hasDots
          ? "Prima! Deine Schrift sieht gut aus. Die Punkte sind da und die Form stimmt."
          : "Prima! Deine Schrift sieht gut aus. Die Form stimmt und du bleibst auf den Linien.";
        cssClass = "success";
      } else if (score >= 50) {
        emoji = "‚úÖ";
        title = "Geschafft!";
        text = hasDots
          ? "Gut gemacht! Die Form ist erkennbar und die Punkte sind da. √úbe weiter!"
          : "Gut gemacht! Die Form ist erkennbar. √úbe weiter f√ºr noch mehr Genauigkeit!";
        cssClass = "success";
      } else if (score >= 35) {
        emoji = "üí™";
        title = "Fast geschafft!";
        text = hasDots
          ? "Fast! Achte auf die Punkte oben ‚Äì sie geh√∂ren zum Buchstaben. Spure langsam nach!"
          : "Fast! Versuch die Vorlage genauer nachzuspuren. Folge den Linien langsam.";
        cssClass = "partial";
      } else {
        emoji = "üéØ";
        title = "Versuch es nochmal!";
        text = hasDots
          ? "Schau dir die Vorlage gut an: Der Buchstabe hat Punkte oben. Spure beides nach!"
          : "Schau dir die Vorlage gut an: Wo beginnt der Buchstabe? Spure langsam nach!";
        cssClass = "try-again";
      }

      feedbackBox.classList.add(cssClass);
      feedbackTitle.textContent = emoji + " " + title;
      feedbackText.textContent = text;
      scoreFill.style.width = score + "%";
    }

    function hideFeedback() {
      feedbackBox.classList.add('hidden');
      scoreFill.style.width = "0%";
    }

    colorDots.forEach(dot => {
      dot.addEventListener("click", () => {
        colorDots.forEach(d => d.classList.remove("active"));
        dot.classList.add("active");
        penColor = dot.dataset.color;
      });
    });

    btnPrev.addEventListener("click", () => setCharByIndex(index - 1));
    btnNext.addEventListener("click", () => setCharByIndex(index + 1));
    btnRandom.addEventListener("click", () => {
      const rnd = Math.floor(Math.random() * list.length);
      setCharByIndex(rnd);
    });
    btnClear.addEventListener("click", clearCanvas);
    btnCheck.addEventListener("click", checkDrawing);

    btnToggleGuide.addEventListener("click", () => {
      showGuide = !showGuide;
      btnToggleGuide.textContent = showGuide ? "üëÅ Vorlage aus" : "üëÅ Vorlage an";
      clearCanvas();
    });

    charSelect.addEventListener("change", () => {
      const i = parseInt(charSelect.value, 10) || 0;
      setCharByIndex(i);
    });

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        setMode(btn.dataset.mode);
      });
    });

    window.addEventListener("resize", resizeCanvas);
    window.addEventListener("orientationchange", () => setTimeout(resizeCanvas, 150));

    function init() {
      setMode("upper");
      fillCharSelect();
      setCharByIndex(0);
      resizeCanvas();
    }
    init();
  </script>
</body>
</html>
