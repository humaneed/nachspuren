<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#D4A574">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Alphabet Nachspuren ‚Äì Kidsneed</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
  <!-- Schulschrift-√§hnliche Schrift f√ºr Buchstaben -->
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --s-1:8px;--s-2:16px;--s-3:24px;--s-4:32px;
      --radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-xl:28px;
      --shadow-soft:0 2px 10px rgba(45,42,38,.10);--shadow-subtle:0 1px 3px rgba(45,42,38,.06);
      --bg-canvas:#F5F0E8;--bg-card:#FFFFFF;--bg-muted:#EDE8DC;
      --ink-primary:#2D2A26;--ink-secondary:#6B665C;--ink-light:#9C9588;
      --accent:#D4A574;--accent-light:rgba(212,165,116,.12);--accent-dark:#B48554;
      --color-success:#7BA08A;--color-success-bg:rgba(123,160,138,.15);
      --color-error:#C4726C;--color-error-bg:rgba(196,114,108,.15);
      --color-warn:#D4A574;--color-warn-bg:rgba(212,165,116,.15);
      --text-2xl:24px;--text-xl:20px;--text-lg:18px;--text-md:16px;--text-sm:14px;--text-xs:12px;
      --motion-fast:150ms;--ease-out:cubic-bezier(0.33,1,0.68,1);
      --app-max-w:600px;--font:'Nunito',system-ui,sans-serif;
      /* Linienfarben */
      --line-base:#C4726C;
      --line-mid:#4A7C91;
      --line-top:#7BA08A;
      --line-light:rgba(0,0,0,0.08);
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg-canvas);color:var(--ink-primary);font-family:var(--font);font-weight:600;font-size:var(--text-md);line-height:1.5;display:flex;align-items:center;justify-content:center;overflow:hidden}
    *:focus-visible{outline:3px solid var(--accent);outline-offset:2px;border-radius:var(--radius-sm)}

    .app-frame{width:100%;height:100%;background:var(--bg-card);display:flex;flex-direction:column;overflow:hidden;position:relative}
    @media(min-width:520px){body{padding:var(--s-3)}.app-frame{max-width:var(--app-max-w);height:94dvh;max-height:940px;border:3px solid var(--ink-primary);border-radius:var(--radius-lg);box-shadow:var(--shadow-subtle)}}

    header{height:72px;padding:0 var(--s-3);display:flex;align-items:center;justify-content:space-between;gap:var(--s-2);border-bottom:3px solid var(--ink-primary);background:var(--bg-card);flex:0 0 auto}
    .brand{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title{font-size:var(--text-xl);font-weight:900;letter-spacing:-0.02em;line-height:1.1;display:flex;align-items:center;gap:var(--s-1)}
    .brand-subtitle{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary)}
    .header-stats{display:flex;gap:var(--s-1);align-items:center}

    .pill{min-height:48px;padding:10px 12px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;gap:6px;user-select:none;cursor:pointer;transition:transform var(--motion-fast) var(--ease-out)}
    .pill:hover{box-shadow:var(--shadow-soft);transform:translateY(-1px)}
    .pill:active{transform:scale(0.98)}
    .pill .icon{font-size:16px}
    .pill .val{font-weight:900;font-size:var(--text-sm);font-variant-numeric:tabular-nums}

    .viewport{flex:1;overflow-y:auto;padding:var(--s-3);background:radial-gradient(1200px 340px at 50% 0%,rgba(212,165,116,.10),transparent 60%),var(--bg-card);overscroll-behavior:contain}

    .card{border:3px solid var(--ink-primary);border-radius:var(--radius-lg);background:var(--bg-card);box-shadow:var(--shadow-subtle);margin-bottom:var(--s-3)}
    .card-section{padding:var(--s-3)}
    .card-section+.card-section{border-top:3px solid var(--ink-primary)}
    .section-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary);margin-bottom:var(--s-2)}

    /* Mode Tabs */
    .mode-tabs{display:flex;gap:var(--s-1);margin-bottom:var(--s-2)}
    .mode-tab{flex:1;min-height:48px;padding:12px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-family:var(--font);font-weight:900;font-size:var(--text-sm);color:var(--ink-secondary);cursor:pointer;transition:all var(--motion-fast) var(--ease-out);text-align:center}
    .mode-tab:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .mode-tab.active{background:var(--accent);color:white;border-color:var(--accent-dark)}

    /* Progress */
    .progress-wrap{margin-bottom:var(--s-2)}
    .progress-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--s-1)}
    .progress-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-secondary)}
    .progress-counter{font-size:var(--text-md);font-weight:900;color:var(--accent)}
    .progress-bar{height:12px;background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .3s var(--ease-out);width:0}

    /* Word Display */
    .word-display{background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md);padding:var(--s-2);margin-bottom:var(--s-2);text-align:center;display:none}
    .word-display.active{display:block}
    .word-letters{display:flex;justify-content:center;gap:4px;flex-wrap:wrap}
    .word-letter{font-size:var(--text-2xl);font-weight:900;padding:4px 8px;border-radius:var(--radius-sm);background:var(--bg-card);border:2px solid var(--ink-light);color:var(--ink-light);transition:all var(--motion-fast)}
    .word-letter.current{background:var(--accent-light);border-color:var(--accent);color:var(--accent);transform:scale(1.1)}
    .word-letter.done{background:var(--color-success-bg);border-color:var(--color-success);color:var(--color-success)}
    .word-label{font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary);margin-top:var(--s-1);text-transform:uppercase;letter-spacing:.08em}

    /* Canvas Stage */
    .stage{border:3px solid var(--ink-primary);border-radius:var(--radius-md);overflow:hidden;background:#FFFEF9}
    .stage-header{padding:12px 14px;border-bottom:3px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;justify-content:space-between;gap:var(--s-2);flex-wrap:wrap}
    .stage-info{display:flex;align-items:center;gap:var(--s-2)}
    .big-letter{font-size:var(--text-2xl);font-weight:900;color:var(--accent);min-width:50px;text-align:center}
    .stage-hint{font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary);text-transform:uppercase;letter-spacing:.08em}
    .stage-score{font-size:var(--text-sm);font-weight:900;color:var(--ink-secondary)}

    /* Linien-Legende */
    .lines-legend{display:flex;gap:var(--s-2);font-size:var(--text-xs);font-weight:900;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:4px}
    .legend-line{width:20px;height:3px;border-radius:2px}
    .legend-line.top{background:var(--line-top)}
    .legend-line.mid{background:var(--line-mid)}
    .legend-line.base{background:var(--line-base)}

    .canvas-wrap{position:relative;width:100%;background:#FFFEF9;touch-action:none}
    canvas{display:block;width:100%;height:auto}
    #bgCanvas{position:relative;z-index:1}
    #drawCanvas{position:absolute;inset:0;z-index:2}

    /* Controls */
    .controls{margin-top:var(--s-2)}
    .controls-row{display:flex;gap:var(--s-2);margin-bottom:var(--s-2);flex-wrap:wrap}
    .control-box{flex:1;min-width:140px;padding:var(--s-2);background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md)}
    .control-label{display:flex;align-items:center;justify-content:space-between;font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-secondary);margin-bottom:var(--s-1)}
    .control-value{font-weight:900;color:var(--accent)}
    input[type="range"]{width:100%;margin:var(--s-1) 0;accent-color:var(--accent)}

    /* Toggle Switch */
    .toggle-row{display:flex;justify-content:space-between;align-items:center;padding:var(--s-1) 0}
    .toggle-label{font-size:var(--text-sm);font-weight:900;color:var(--ink-primary)}
    .toggle{width:52px;height:32px;background:var(--bg-canvas);border:2px solid var(--ink-primary);border-radius:16px;position:relative;cursor:pointer;transition:background var(--motion-fast)}
    .toggle::after{content:'';position:absolute;width:24px;height:24px;background:var(--bg-card);border:2px solid var(--ink-primary);border-radius:12px;top:2px;left:2px;transition:left var(--motion-fast)}
    .toggle.on{background:var(--color-success);border-color:var(--color-success)}
    .toggle.on::after{left:22px;border-color:var(--color-success)}

    /* Color Swatches */
    .swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:var(--s-1)}
    .swatch{width:36px;height:36px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);cursor:pointer;transition:transform var(--motion-fast)}
    .swatch:hover{transform:scale(1.1)}
    .swatch.active{outline:3px solid var(--accent);outline-offset:2px}

    /* Buttons */
    .btn{min-height:48px;padding:12px 14px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-card);color:var(--ink-secondary);font-family:var(--font);font-weight:900;font-size:var(--text-sm);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all var(--motion-fast) var(--ease-out);user-select:none}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .btn:active{transform:translateY(1px);box-shadow:none}
    .btn.primary{background:var(--accent);color:white;border-color:var(--accent-dark)}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.success{background:var(--color-success);color:white;border-color:var(--color-success)}
    .btn.danger{background:var(--color-error-bg);color:var(--color-error);border-color:var(--color-error)}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--s-1);margin-top:var(--s-2)}
    .actions .btn{flex:1}
    .actions-main{display:flex;gap:var(--s-2);margin-top:var(--s-2)}
    .actions-main .btn{flex:1}

    /* Feedback */
    .feedback{margin-top:var(--s-2);padding:var(--s-2);border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-weight:800;font-size:var(--text-sm);color:var(--ink-secondary);display:none;align-items:flex-start;gap:10px}
    .feedback.open{display:flex}
    .feedback .ficon{font-size:18px;flex-shrink:0}
    .feedback.success{background:var(--color-success-bg);border-color:var(--color-success);color:#2D5A3A}
    .feedback.error{background:var(--color-error-bg);border-color:var(--color-error);color:#6B3A32}

    footer{flex:0 0 auto;padding:var(--s-2) var(--s-3);padding-bottom:max(var(--s-2),env(safe-area-inset-bottom));background:var(--bg-card);border-top:3px solid var(--ink-primary);display:flex;gap:var(--s-2)}
    footer .btn{flex:1}

    @media(max-width:400px){
      header{padding:0 var(--s-2)}
      .viewport{padding:var(--s-2)}
      footer{padding:var(--s-2)}
      .brand-title{font-size:var(--text-lg)}
      .actions{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <header>
      <div class="brand">
        <div class="brand-title">‚úèÔ∏è Alphabet Nachspuren</div>
        <div class="brand-subtitle">Kidsneed ¬∑ Buchstaben & W√∂rter</div>
      </div>
      <div class="header-stats">
        <div class="pill" id="stats-pill">
          <span class="icon">‚≠ê</span>
          <span class="val" id="coin-count">0</span>
        </div>
      </div>
    </header>

    <main class="viewport">
      <div class="card">
        <!-- Mode Selection -->
        <section class="card-section">
          <div class="section-label">Modus w√§hlen</div>
          <div class="mode-tabs">
            <button class="mode-tab active" data-mode="letter" type="button">üî§ Buchstaben</button>
            <button class="mode-tab" data-mode="word" type="button">üìù W√∂rter</button>
          </div>

          <!-- Progress -->
          <div class="progress-wrap">
            <div class="progress-info">
              <span class="progress-label" id="progress-label">Fortschritt</span>
              <span class="progress-counter" id="progress-counter">0/30</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>

          <!-- Word Display (for word mode) -->
          <div class="word-display" id="word-display">
            <div class="word-letters" id="word-letters"></div>
            <div class="word-label" id="word-hint">Spure jeden Buchstaben nach</div>
          </div>
        </section>

        <!-- Canvas Stage -->
        <section class="card-section">
          <div class="stage">
            <div class="stage-header">
              <div class="stage-info">
                <div class="big-letter" id="big-letter">A a</div>
                <div class="stage-hint" id="stage-hint">Spur den Buchstaben nach</div>
              </div>
              <div class="lines-legend">
                <div class="legend-item"><div class="legend-line top"></div><span>Oben</span></div>
                <div class="legend-item"><div class="legend-line mid"></div><span>Mitte</span></div>
                <div class="legend-item"><div class="legend-line base"></div><span>Grund</span></div>
              </div>
            </div>
            <div class="canvas-wrap" id="canvas-wrap">
              <canvas id="bgCanvas"></canvas>
              <canvas id="drawCanvas"></canvas>
            </div>
          </div>

          <!-- Toggles -->
          <div style="display:flex;gap:var(--s-3);margin-top:var(--s-2);flex-wrap:wrap">
            <div class="toggle-row" style="flex:1">
              <span class="toggle-label">üëÅÔ∏è Buchstabe zeigen</span>
              <div class="toggle on" id="toggle-letter" role="switch" tabindex="0"></div>
            </div>
            <div class="toggle-row" style="flex:1">
              <span class="toggle-label">üìè Linien zeigen</span>
              <div class="toggle on" id="toggle-lines" role="switch" tabindex="0"></div>
            </div>
          </div>
        </section>

        <!-- Controls -->
        <section class="card-section">
          <div class="controls">
            <div class="controls-row">
              <div class="control-box">
                <div class="control-label">
                  <span>üñåÔ∏è Pinselgr√∂√üe</span>
                  <span class="control-value" id="brush-val">12</span>
                </div>
                <input type="range" id="brush-size" min="4" max="30" value="12">
                <div class="toggle-row">
                  <span class="toggle-label">üßΩ Radierer</span>
                  <div class="toggle" id="toggle-eraser" role="switch" tabindex="0"></div>
                </div>
              </div>
              <div class="control-box">
                <div class="control-label">
                  <span>üé® Farbe</span>
                </div>
                <div class="swatches" id="color-swatches">
                  <div class="swatch active" data-color="#2D2A26" style="background:#2D2A26"></div>
                  <div class="swatch" data-color="#4A7C91" style="background:#4A7C91"></div>
                  <div class="swatch" data-color="#C4726C" style="background:#C4726C"></div>
                  <div class="swatch" data-color="#7BA08A" style="background:#7BA08A"></div>
                  <div class="swatch" data-color="#8B7BA0" style="background:#8B7BA0"></div>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn" id="btn-prev" type="button">‚¨ÖÔ∏è Zur√ºck</button>
              <button class="btn" id="btn-next" type="button">Weiter ‚û°Ô∏è</button>
              <button class="btn" id="btn-random" type="button">üé≤ Zufall</button>
              <button class="btn" id="btn-undo" type="button">‚Ü©Ô∏è R√ºckg√§ngig</button>
              <button class="btn danger" id="btn-clear" type="button">üßº L√∂schen</button>
              <button class="btn" id="btn-check" type="button">üîç Pr√ºfen</button>
            </div>

            <div class="actions-main">
              <button class="btn success" id="btn-done" type="button">‚úÖ Fertig & Weiter</button>
            </div>
          </div>

          <div class="feedback" id="feedback">
            <span class="ficon" id="feedback-icon">üí°</span>
            <span id="feedback-text">Tipp: Spur langsam und sauber nach!</span>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <a class="btn" href="https://humaneed.github.io/kidsneed/">‚Üê Hub</a>
      <button class="btn" id="btn-help" type="button">üí° Hilfe</button>
    </footer>
  </div>

  <script>
(()=>{
  'use strict';
  const $=s=>document.querySelector(s);
  const $$=s=>[...document.querySelectorAll(s)];

  // ===== LOCAL STORAGE =====
  const LS={coins:'kidsneed_coins',lettersDone:'kidsneed_alpha_letters',wordsDone:'kidsneed_alpha_words',lastIdx:'kidsneed_alpha_idx'};
  const getInt=(k,fb=0)=>{try{const v=localStorage.getItem(k);return v?parseInt(v,10)||fb:fb}catch{return fb}};
  const setStr=(k,v)=>{try{localStorage.setItem(k,String(v))}catch{}};
  const getArr=(k)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):[]}catch{return[]}};
  const setArr=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};

  // ===== BUCHSTABEN-DATEN =====
  // Jeder Buchstabe hat: id, gro√ü, klein, Farbe (aus dem Bild)
  const LETTERS=[
    {id:'A',upper:'A',lower:'a',color:'#D4976A'},
    {id:'B',upper:'B',lower:'b',color:'#A67B5B'},
    {id:'C',upper:'C',lower:'c',color:'#E8A84C'},
    {id:'D',upper:'D',lower:'d',color:'#F5C04A'},
    {id:'E',upper:'E',lower:'e',color:'#E8D174'},
    {id:'F',upper:'F',lower:'f',color:'#8B6B4A'},
    {id:'G',upper:'G',lower:'g',color:'#6B8E6B'},
    {id:'H',upper:'H',lower:'h',color:'#4A8B8B'},
    {id:'I',upper:'I',lower:'i',color:'#5BA3A3'},
    {id:'J',upper:'J',lower:'j',color:'#7B9EB8'},
    {id:'K',upper:'K',lower:'k',color:'#5B8B7B'},
    {id:'L',upper:'L',lower:'l',color:'#7BA08A'},
    {id:'M',upper:'M',lower:'m',color:'#C4A864'},
    {id:'N',upper:'N',lower:'n',color:'#6B7BA0'},
    {id:'O',upper:'O',lower:'o',color:'#8BA0C4'},
    {id:'P',upper:'P',lower:'p',color:'#7B6B90'},
    {id:'Q',upper:'Q',lower:'q',color:'#6B5B80'},
    {id:'R',upper:'R',lower:'r',color:'#A06B8B'},
    {id:'S',upper:'S',lower:'s',color:'#D4A0A0'},
    {id:'T',upper:'T',lower:'t',color:'#C4726C'},
    {id:'U',upper:'U',lower:'u',color:'#E8A060'},
    {id:'V',upper:'V',lower:'v',color:'#D4A574'},
    {id:'W',upper:'W',lower:'w',color:'#C49840'},
    {id:'X',upper:'X',lower:'x',color:'#8090A0'},
    {id:'Y',upper:'Y',lower:'y',color:'#606B70'},
    {id:'Z',upper:'Z',lower:'z',color:'#505860'},
    {id:'√Ñ',upper:'√Ñ',lower:'√§',color:'#606060'},
    {id:'√ñ',upper:'√ñ',lower:'√∂',color:'#707070'},
    {id:'√ú',upper:'√ú',lower:'√º',color:'#505050'},
    {id:'√ü',upper:'√ü',lower:'√ü',color:'#404040'}
  ];

  // W√∂rter f√ºr den Wort-Modus
  const WORDS=[
    {word:'OMA',hint:'Familie'},
    {word:'OPA',hint:'Familie'},
    {word:'EIS',hint:'Lecker!'},
    {word:'ARM',hint:'K√∂rperteil'},
    {word:'OHR',hint:'K√∂rperteil'},
    {word:'ROT',hint:'Farbe'},
    {word:'HUT',hint:'Kleidung'},
    {word:'BUS',hint:'Fahrzeug'},
    {word:'RAD',hint:'Fahrzeug'},
    {word:'BALL',hint:'Spielzeug'},
    {word:'HAUS',hint:'Geb√§ude'},
    {word:'BAUM',hint:'Natur'},
    {word:'HUND',hint:'Tier'},
    {word:'AUTO',hint:'Fahrzeug'},
    {word:'MAMA',hint:'Familie'},
    {word:'PAPA',hint:'Familie'},
    {word:'BUCH',hint:'Lesen'},
    {word:'BROT',hint:'Essen'},
    {word:'NASE',hint:'K√∂rperteil'},
    {word:'SONNE',hint:'Am Himmel'},
    {word:'WOLKE',hint:'Am Himmel'},
    {word:'BLUME',hint:'Natur'},
    {word:'KATZE',hint:'Tier'},
    {word:'VOGEL',hint:'Tier'},
    {word:'SCHULE',hint:'Lernen'},
    {word:'KINDER',hint:'Mehrzahl'},
    {word:'WASSER',hint:'Trinken'},
    {word:'√ÑPFEL',hint:'Obst'},
    {word:'L√ñWE',hint:'Tier'},
    {word:'M√úTZE',hint:'Kleidung'}
  ];

  // Buchstaben-Map
  const LETTER_MAP={};
  LETTERS.forEach((l,i)=>{LETTER_MAP[l.id]=i;LETTER_MAP[l.id.toLowerCase()]=i});

  // ===== STATE =====
  const state={
    mode:'letter',
    letterIdx:Math.min(getInt(LS.lastIdx,0),LETTERS.length-1),
    wordIdx:0,
    wordCharIdx:0,
    lettersDone:new Set(getArr(LS.lettersDone)),
    wordsDone:new Set(getArr(LS.wordsDone)),
    showLetter:true,
    showLines:true,
    isEraser:false,
    brushColor:'#2D2A26',
    brushSize:12,
    undoStack:[],
    painting:false,
    lastPos:null
  };

  // ===== DOM =====
  const coinCount=$('#coin-count');
  const progressLabel=$('#progress-label');
  const progressCounter=$('#progress-counter');
  const progressFill=$('#progress-fill');
  const wordDisplay=$('#word-display');
  const wordLetters=$('#word-letters');
  const wordHint=$('#word-hint');
  const bigLetter=$('#big-letter');
  const stageHint=$('#stage-hint');
  const feedback=$('#feedback');
  const feedbackIcon=$('#feedback-icon');
  const feedbackText=$('#feedback-text');
  const bgCanvas=$('#bgCanvas');
  const drawCanvas=$('#drawCanvas');
  const canvasWrap=$('#canvas-wrap');
  const bgCtx=bgCanvas.getContext('2d',{willReadFrequently:true});
  const drawCtx=drawCanvas.getContext('2d',{willReadFrequently:true});

  let dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
  const UNDO_MAX=15;

  // ===== HELPERS =====
  const showFeedback=(icon,text,type='')=>{
    feedbackIcon.textContent=icon;
    feedbackText.innerHTML=text;
    feedback.className='feedback open'+(type?' '+type:'');
  };
  const hideFeedback=()=>feedback.classList.remove('open');

  const updateCoins=()=>{coinCount.textContent=getInt(LS.coins,0)};
  const addCoin=(n=1)=>{
    const c=getInt(LS.coins,0)+n;
    setStr(LS.coins,c);
    updateCoins();
    $('#stats-pill').style.transform='scale(1.1)';
    setTimeout(()=>$('#stats-pill').style.transform='',200);
  };

  const saveState=()=>{
    setStr(LS.lastIdx,state.letterIdx);
    setArr(LS.lettersDone,[...state.lettersDone]);
    setArr(LS.wordsDone,[...state.wordsDone]);
  };

  // ===== PROGRESS =====
  const updateProgress=()=>{
    if(state.mode==='letter'){
      const done=state.lettersDone.size;
      progressLabel.textContent='Buchstaben';
      progressCounter.textContent=`${done}/${LETTERS.length}`;
      progressFill.style.width=`${Math.round(done/LETTERS.length*100)}%`;
    }else{
      const done=state.wordsDone.size;
      progressLabel.textContent='W√∂rter';
      progressCounter.textContent=`${done}/${WORDS.length}`;
      progressFill.style.width=`${Math.round(done/WORDS.length*100)}%`;
    }
  };

  // ===== CANVAS SETUP =====
  const fitCanvas=()=>{
    const w=canvasWrap.clientWidth;
    const h=Math.max(220,Math.min(320,Math.round(w*0.5)));
    bgCanvas.style.height=h+'px';
    drawCanvas.style.height=h+'px';
    bgCanvas.width=Math.round(w*dpr);
    bgCanvas.height=Math.round(h*dpr);
    drawCanvas.width=Math.round(w*dpr);
    drawCanvas.height=Math.round(h*dpr);
  };

  // ===== BUCHSTABEN-KATEGORIEN =====
  // Kleinbuchstaben mit Unterl√§ngen (gehen unter die Grundlinie)
  const DESCENDERS = new Set(['g','j','p','q','y']);
  // Kleinbuchstaben mit Oberl√§ngen (gehen bis Oberlinie)
  const ASCENDERS = new Set(['b','d','f','h','k','l','t','√ü']);
  // Kleinbuchstaben nur x-H√∂he (zwischen Grund- und Mittellinie)
  const XHEIGHT = new Set(['a','c','e','i','m','n','o','r','s','u','v','w','x','z','√§','√∂','√º']);

  // ===== ZEICHNE LINIEN UND BUCHSTABEN =====
  const renderLetter=(idx)=>{
    if(idx<0||idx>=LETTERS.length)return;
    const letter=LETTERS[idx];
    
    // UI Update
    bigLetter.textContent=`${letter.upper} ${letter.lower}`;
    bigLetter.style.color=letter.color;
    const isDone=state.lettersDone.has(letter.id);
    stageHint.textContent=isDone?'‚úÖ Bereits geschafft':'Spur den Buchstaben nach';
    
    hideFeedback();
    clearDrawing(true);
    fitCanvas();

    const cw=bgCanvas.width;
    const ch=bgCanvas.height;

    bgCtx.save();
    bgCtx.setTransform(1,0,0,1,0,0);
    bgCtx.clearRect(0,0,cw,ch);
    
    // Hintergrund (leicht get√∂nt wie Schulheft)
    bgCtx.fillStyle='#FFFEF9';
    bgCtx.fillRect(0,0,cw,ch);

    // ===== LINIEN-POSITIONEN (fest definiert) =====
    const margin=20*dpr;
    
    // Vertikale Positionen der Linien (von oben nach unten)
    const topY = ch * 0.15;      // Oberlinie (Gro√übuchstaben/Oberl√§ngen)
    const midY = ch * 0.45;      // Mittellinie (x-H√∂he Kleinbuchstaben)
    const baseY = ch * 0.72;     // Grundlinie (Schreiblinie)
    const descY = ch * 0.92;     // Unterl√§ngen-Linie
    
    // Abst√§nde berechnen
    const upperHeight = baseY - topY;    // H√∂he Gro√übuchstaben
    const xHeight = baseY - midY;        // H√∂he Kleinbuchstaben (x-H√∂he)
    const descHeight = descY - baseY;    // Unterl√§ngen

    if(state.showLines){
      bgCtx.lineWidth=2*dpr;
      
      // Oberlinie (gr√ºn, gestrichelt) - Gro√übuchstaben-Oberkante
      bgCtx.strokeStyle='rgba(123,160,138,0.7)';
      bgCtx.setLineDash([10*dpr,5*dpr]);
      bgCtx.beginPath();
      bgCtx.moveTo(margin,topY);
      bgCtx.lineTo(cw-margin,topY);
      bgCtx.stroke();
      
      // Mittellinie (blau, gestrichelt) - Kleinbuchstaben-Oberkante
      bgCtx.strokeStyle='rgba(74,124,145,0.7)';
      bgCtx.setLineDash([10*dpr,5*dpr]);
      bgCtx.beginPath();
      bgCtx.moveTo(margin,midY);
      bgCtx.lineTo(cw-margin,midY);
      bgCtx.stroke();
      
      // Grundlinie (rot, durchgezogen) - Schreiblinie
      bgCtx.strokeStyle='rgba(196,114,108,0.9)';
      bgCtx.setLineDash([]);
      bgCtx.lineWidth=3*dpr;
      bgCtx.beginPath();
      bgCtx.moveTo(margin,baseY);
      bgCtx.lineTo(cw-margin,baseY);
      bgCtx.stroke();

      // Unterl√§ngen-Linie (grau, gestrichelt)
      bgCtx.strokeStyle='rgba(0,0,0,0.2)';
      bgCtx.lineWidth=2*dpr;
      bgCtx.setLineDash([6*dpr,4*dpr]);
      bgCtx.beginPath();
      bgCtx.moveTo(margin,descY);
      bgCtx.lineTo(cw-margin,descY);
      bgCtx.stroke();
    }

    // ===== BUCHSTABE ZEICHNEN =====
    if(state.showLetter){
      bgCtx.setLineDash([]);
      bgCtx.textAlign='center';
      
      // Buchstabenfarbe (halbtransparent zum Nachspuren)
      bgCtx.fillStyle=letter.color+'88'; // 53% opacity
      bgCtx.strokeStyle=letter.color;
      bgCtx.lineWidth=2*dpr;
      
      // ===== GRO√üBUCHSTABE (links) =====
      // Gro√übuchstaben gehen von Grundlinie bis Oberlinie
      const upperFontSize = upperHeight * 1.05; // Etwas gr√∂√üer f√ºr optischen Ausgleich
      bgCtx.font=`600 ${upperFontSize}px 'Nunito', sans-serif`;
      bgCtx.textBaseline='alphabetic';
      
      const upperX = cw * 0.28;
      bgCtx.fillText(letter.upper, upperX, baseY);
      bgCtx.strokeText(letter.upper, upperX, baseY);
      
      // ===== KLEINBUCHSTABE (rechts) =====
      const lowerX = cw * 0.72;
      const lowerChar = letter.lower;
      
      // Schriftgr√∂√üe je nach Buchstabentyp
      let lowerFontSize;
      let lowerBaseline = baseY;
      
      if(ASCENDERS.has(lowerChar)){
        // Oberl√§ngen: gleiche H√∂he wie Gro√übuchstaben
        lowerFontSize = upperHeight * 1.05;
      } else if(DESCENDERS.has(lowerChar)){
        // Unterl√§ngen: x-H√∂he + Unterl√§nge
        lowerFontSize = (xHeight + descHeight) * 0.95;
      } else {
        // Normale x-H√∂he Buchstaben
        lowerFontSize = xHeight * 1.4; // Optischer Ausgleich
      }
      
      bgCtx.font=`600 ${lowerFontSize}px 'Nunito', sans-serif`;
      bgCtx.fillText(lowerChar, lowerX, lowerBaseline);
      bgCtx.strokeText(lowerChar, lowerX, lowerBaseline);

      // Pfeil zwischen Gro√ü und Klein
      bgCtx.fillStyle='rgba(0,0,0,0.25)';
      bgCtx.font=`400 ${20*dpr}px sans-serif`;
      bgCtx.textBaseline='middle';
      bgCtx.fillText('‚Üí', cw*0.5, (topY+baseY)/2);
    }

    bgCtx.restore();
  };

  // ===== WORD MODE =====
  const renderWordDisplay=()=>{
    if(state.mode!=='word'){
      wordDisplay.classList.remove('active');
      return;
    }
    wordDisplay.classList.add('active');
    const w=WORDS[state.wordIdx];
    wordHint.textContent=`Hinweis: ${w.hint}`;
    wordLetters.innerHTML='';
    for(let i=0;i<w.word.length;i++){
      const span=document.createElement('span');
      span.className='word-letter';
      span.textContent=w.word[i];
      if(i<state.wordCharIdx)span.classList.add('done');
      if(i===state.wordCharIdx)span.classList.add('current');
      wordLetters.appendChild(span);
    }
  };

  const getCurrentLetterIdxForWord=()=>{
    const w=WORDS[state.wordIdx];
    const char=w.word[state.wordCharIdx];
    return LETTER_MAP[char.toUpperCase()]??0;
  };

  const advanceWord=()=>{
    const w=WORDS[state.wordIdx];
    state.wordCharIdx++;
    if(state.wordCharIdx>=w.word.length){
      if(!state.wordsDone.has(w.word)){
        state.wordsDone.add(w.word);
        addCoin(w.word.length);
        showFeedback('üéâ',`<strong>Super!</strong> "${w.word}" geschafft! ‚≠ê +${w.word.length}`,'success');
      }else{
        showFeedback('‚ú®',`<strong>Nochmal ge√ºbt!</strong> "${w.word}" gemeistert.`,'success');
      }
      saveState();
      updateProgress();
      setTimeout(()=>{
        state.wordIdx=(state.wordIdx+1)%WORDS.length;
        state.wordCharIdx=0;
        renderTask();
      },1500);
    }else{
      renderWordDisplay();
      renderLetter(getCurrentLetterIdxForWord());
    }
  };

  // ===== RENDER TASK =====
  const renderTask=()=>{
    updateProgress();
    if(state.mode==='letter'){
      wordDisplay.classList.remove('active');
      renderLetter(state.letterIdx);
    }else{
      renderWordDisplay();
      renderLetter(getCurrentLetterIdxForWord());
    }
  };

  // ===== DRAWING =====
  const pushUndo=()=>{
    try{
      const snap=drawCtx.getImageData(0,0,drawCanvas.width,drawCanvas.height);
      state.undoStack.push(snap);
      if(state.undoStack.length>UNDO_MAX)state.undoStack.shift();
    }catch{}
  };

  const clearDrawing=(hard=false)=>{
    drawCtx.save();
    drawCtx.setTransform(1,0,0,1,0,0);
    drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    drawCtx.restore();
    if(hard)state.undoStack=[];
  };

  const setBrushStyle=()=>{
    drawCtx.lineCap='round';
    drawCtx.lineJoin='round';
    drawCtx.lineWidth=state.brushSize*dpr;
    if(state.isEraser){
      drawCtx.globalCompositeOperation='destination-out';
      drawCtx.strokeStyle='rgba(0,0,0,1)';
    }else{
      drawCtx.globalCompositeOperation='source-over';
      drawCtx.strokeStyle=state.brushColor;
    }
  };

  const getPos=(e)=>{
    const rect=drawCanvas.getBoundingClientRect();
    return{x:(e.clientX-rect.left)*dpr,y:(e.clientY-rect.top)*dpr};
  };

  const beginDraw=(e)=>{
    state.painting=true;
    state.lastPos=getPos(e);
    pushUndo();
    setBrushStyle();
    drawCtx.beginPath();
    drawCtx.moveTo(state.lastPos.x,state.lastPos.y);
    // Punkt zeichnen f√ºr Klick ohne Bewegung
    drawCtx.lineTo(state.lastPos.x+0.1,state.lastPos.y+0.1);
    drawCtx.stroke();
  };

  const moveDraw=(e)=>{
    if(!state.painting)return;
    const p=getPos(e);
    drawCtx.lineTo(p.x,p.y);
    drawCtx.stroke();
    drawCtx.beginPath();
    drawCtx.moveTo(p.x,p.y);
    state.lastPos=p;
  };

  const endDraw=()=>{
    state.painting=false;
    state.lastPos=null;
  };

  drawCanvas.addEventListener('pointerdown',e=>{drawCanvas.setPointerCapture(e.pointerId);beginDraw(e)});
  drawCanvas.addEventListener('pointermove',moveDraw);
  drawCanvas.addEventListener('pointerup',endDraw);
  drawCanvas.addEventListener('pointercancel',endDraw);
  drawCanvas.addEventListener('pointerleave',endDraw);

  // ===== SCORING (vereinfacht - pr√ºft ob genug gezeichnet wurde) =====
  const checkDrawing=()=>{
    const img=drawCtx.getImageData(0,0,drawCanvas.width,drawCanvas.height).data;
    let drawn=0;
    for(let i=3;i<img.length;i+=4){
      if(img[i]>20)drawn++;
    }
    const totalPixels=drawCanvas.width*drawCanvas.height;
    const coverage=drawn/totalPixels*100;
    return{coverage:coverage.toFixed(1),drawn};
  };

  // ===== MARK DONE =====
  const markDone=()=>{
    const check=checkDrawing();
    if(check.coverage<0.5){
      showFeedback('üí°','<strong>Noch nicht genug!</strong> Mal den Buchstaben nach.','error');
      return;
    }

    if(state.mode==='letter'){
      const letter=LETTERS[state.letterIdx];
      if(!state.lettersDone.has(letter.id)){
        state.lettersDone.add(letter.id);
        addCoin(1);
        showFeedback('‚úÖ',`<strong>${letter.upper} ${letter.lower} geschafft!</strong> ‚≠ê +1`,'success');
      }else{
        showFeedback('‚ú®',`<strong>Nochmal ge√ºbt!</strong> ${letter.upper} ${letter.lower}`,'success');
      }
      saveState();
      updateProgress();
      setTimeout(()=>{
        state.letterIdx=(state.letterIdx+1)%LETTERS.length;
        renderTask();
      },1000);
    }else{
      advanceWord();
    }
  };

  // ===== EVENT HANDLERS =====
  // Mode Tabs
  $$('.mode-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      $$('.mode-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      state.mode=tab.dataset.mode;
      state.wordCharIdx=0;
      renderTask();
    });
  });

  // Letter Toggle
  $('#toggle-letter').addEventListener('click',()=>{
    state.showLetter=!state.showLetter;
    $('#toggle-letter').classList.toggle('on',state.showLetter);
    renderTask();
  });

  // Lines Toggle
  $('#toggle-lines').addEventListener('click',()=>{
    state.showLines=!state.showLines;
    $('#toggle-lines').classList.toggle('on',state.showLines);
    renderTask();
  });

  // Eraser Toggle
  $('#toggle-eraser').addEventListener('click',()=>{
    state.isEraser=!state.isEraser;
    $('#toggle-eraser').classList.toggle('on',state.isEraser);
    setBrushStyle();
  });

  // Brush Size
  $('#brush-size').addEventListener('input',e=>{
    state.brushSize=parseInt(e.target.value,10)||12;
    $('#brush-val').textContent=state.brushSize;
    setBrushStyle();
  });

  // Color Swatches
  $$('.swatch').forEach(sw=>{
    sw.addEventListener('click',()=>{
      $$('.swatch').forEach(s=>s.classList.remove('active'));
      sw.classList.add('active');
      state.brushColor=sw.dataset.color;
      state.isEraser=false;
      $('#toggle-eraser').classList.remove('on');
      setBrushStyle();
    });
  });

  // Navigation
  $('#btn-prev').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=(state.letterIdx-1+LETTERS.length)%LETTERS.length;
    }else{
      state.wordIdx=(state.wordIdx-1+WORDS.length)%WORDS.length;
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-next').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=(state.letterIdx+1)%LETTERS.length;
    }else{
      state.wordIdx=(state.wordIdx+1)%WORDS.length;
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-random').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=Math.floor(Math.random()*LETTERS.length);
    }else{
      state.wordIdx=Math.floor(Math.random()*WORDS.length);
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-undo').addEventListener('click',()=>{
    if(state.undoStack.length){
      const snap=state.undoStack.pop();
      if(snap)drawCtx.putImageData(snap,0,0);
    }
  });

  $('#btn-clear').addEventListener('click',()=>{
    clearDrawing(false);
    showFeedback('üßº','<strong>Gel√∂scht.</strong> Fang nochmal an!');
  });

  $('#btn-check').addEventListener('click',()=>{
    const check=checkDrawing();
    if(check.coverage<0.3){
      showFeedback('üéØ','<strong>Mal noch mehr!</strong> Der Buchstabe braucht mehr Farbe.');
    }else if(check.coverage<1){
      showFeedback('üëç','<strong>Guter Anfang!</strong> Noch etwas mehr nachspuren.');
    }else{
      showFeedback('üèÜ',`<strong>Super!</strong> Du hast gut nachgespurt!`,'success');
    }
  });

  $('#btn-done').addEventListener('click',markDone);

  $('#btn-help').addEventListener('click',()=>{
    showFeedback('üí°',`<strong>So geht's:</strong><br>
      1Ô∏è‚É£ Spur den Buchstaben auf den Linien nach<br>
      2Ô∏è‚É£ üëÅÔ∏è Buchstabe ein/ausblenden zum √úben<br>
      3Ô∏è‚É£ üìè Linien als Orientierung nutzen<br>
      4Ô∏è‚É£ ‚úÖ Fertig speichert & gibt ‚≠ê<br><br>
      <strong>Linien:</strong><br>
      üî¥ Grundlinie = hier schreiben<br>
      üîµ Mittellinie = Kleinbuchstaben-H√∂he<br>
      üü¢ Oberlinie = Gro√übuchstaben-H√∂he`);
  });

  // Resize
  window.addEventListener('resize',()=>{
    dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    renderTask();
  });

  // ===== INIT =====
  const init=()=>{
    updateCoins();
    $('#brush-val').textContent=state.brushSize;
    setBrushStyle();
    renderTask();
  };

  init();
  console.log('‚úÖ Alphabet Nachspuren v2 geladen.');
})();
  </script>
</body>
</html>
